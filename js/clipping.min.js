var UNCLEAR_DETECTING=!0,IS_UNCLEAR=!1;
function isImageUnclear(b,c,t,d,f){if(!1==IS_UNCLEAR){if(t>b||d>c)IS_UNCLEAR=!0,$warning=$("<div></div>"),$warning.addClass("warning"+f.attr("id")),$warning.addClass("warning"),$warning.css("position","absolute"),$warning.css("top",f.css("top")),$warning.css("left",f.css("left")),$warning.css("z-index","998"),$warning.html('<img src="../css/images/warning.png" />'),$warning.children("img")[0].width=32,$warning.children("img")[0].height=32,$("body").append($warning),0>=$(".warning_big").length&&($warning_big=
$("<div class='warning_big'></div>"),$warning_big.css("position","absolute"),$warning_big.css("top",20+layout_oy+"px"),$warning_big.css("left",370+layout_ox+"px"),$warning_big.html('<img src="../css/images/warning.png" align="absmiddle"><span style="font-size: 16px; color: grey">'+$.i18n.prop("Msg_71")+"</span></img>"),$("body").append($warning_big))}else!0==IS_UNCLEAR&&(t<=b&&d<=c)&&(IS_UNCLEAR=!1,removeUnclearWarning(f.attr("id")))}
function removeUnclearWarning(b){$(".warning"+b).remove();0<$(".warning_big").length&&0>=$(".warning").length&&$(".warning_big").remove()}function autoClipper(b,c){var t=$("<canvas>"),d=t[0].getContext("2d");IS_UNCLEAR=!1;t[0].width=$(b).data("zw");t[0].height=$(b).data("zh");d.drawImage(b,0,0,$(b).data("zw"),$(b).data("zh"));c[0].getContext("2d").putImageData(d.getImageData($(b).data("zdx"),$(b).data("zdy"),c[0].width,c[0].height),0,0)}function max(b,c){return b>=c?b:c}
function autoClipper2(b,c,t,d){var f=Math.round(parseInt(d.css("border-left-width"),10)),a=Math.round(parseInt(d.css("width"),10))+f,l=Math.round(parseInt(d.css("height"),10))+f,n=Math.round(parseInt(t.css("width"),10))+f;t=Math.round(parseInt(t.css("height"),10))+f;var g=max(a,l)/max(n,t),n=Math.round($(b).data("zw")*g);t=Math.round($(b).data("zh")*g);n<c[0].width&&(n=Math.round(c[0].width)+f,t=Math.round($(b).data("zh")*(n/$(b).data("zw")))+f);t<c[0].height&&(t=Math.round(c[0].height)+f,n=Math.round($(b).data("zw")*
(t/$(b).data("zh")))+f);!0==UNCLEAR_DETECTING&&(IS_UNCLEAR="true"==$(b).data("is_unclear")?!0:!1,f=new Image,f.src=d.children(".draggable").attr("src"),isImageUnclear(f.width,f.height,n,t,d));$(b).data("zw",n);$(b).data("zh",t);d=Math.round($(b).data("zdx")*g);f=Math.round($(b).data("zdy")*g);t-f<l&&(f=0);n-d<a&&(d=0);$(b).data("zdx",d);$(b).data("zdy",f);a=$("<canvas>");l=a[0].getContext("2d");a[0].width=$(b).data("zw");a[0].height=$(b).data("zh");l.drawImage(b,0,0,$(b).data("zw"),$(b).data("zh"));
c[0].getContext("2d").putImageData(l.getImageData($(b).data("zdx"),$(b).data("zdy"),c[0].width,c[0].height),0,0)}var bMove=new Image;bMove.src="css/images/move.png";var bZoom=new Image;bZoom.src="css/images/zoom.png";var bSave=new Image;bSave.src="css/images/ok.png";var bRemove=new Image;bRemove.src="css/images/del.png";
function realClipper(b,c){function t(a,b,c,d){this.x=a;this.y=b;this.w=c;this.h=d;this.px=a;this.py=b;this.csize=15;this.bHow=[!1,!1,!1,!1];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[!1,!1,!1,!1];this.bDragAll=!1;this.oImg=null}function d(){n.clearRect(-a.csize/2,-a.csize/2,n.canvas.width+a.csize,n.canvas.height+a.csize);a.draw()}function f(){"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove());if(0<=b.attr("class").indexOf("layout_circle")){var c=
$("<canvas>");c[0].width=p+h;c[0].height=q+h;var d=c[0].getContext("2d");d.putImageData(a.oImg,0,0);doClipping(doMasking(c[0],maskImg,b,layout_ox,layout_oy),b,cirClipper)}else 0<=b.attr("class").indexOf("layout_square")&&(c=$("<canvas>"),c[0].width=p+h,c[0].height=q+h,d=c[0].getContext("2d"),d.putImageData(a.oImg,0,0),doClipping(doMasking(c[0],maskImg,b,layout_ox,layout_oy),b,boxClipper));b.next().mouseenter(function(){$(".layout_corner").css("z-index","996");$(this).prev().css("z-index","998")});
b.children(".draggable").data("zdx",r-a.x);b.children(".draggable").data("zdy",k-a.y);b.children(".draggable").data("zw",m);b.children(".draggable").data("zh",s);l.unbind();e.unbind();l.remove();l[0]=null;u.remove();u[0]=null;e.next().remove();e.next()[0]=null;e.remove();e[0]=null;$("body").css("cursor","default")}var a,l,n,g,j=1,r=Math.round(parseInt(b.css("left"),10)),k=Math.round(parseInt(b.css("top"),10)),p=Math.round(parseInt(b.css("width"),10)),q=Math.round(parseInt(b.css("height"),10)),e,u,
h=Math.round(parseInt(b.css("border-left-width"),10)),m,s,z;t.prototype.draw=function(){a.w>=a.h?(m=a.w+h,s=Math.round(c.height*(a.w/c.width))+h,s<a.h&&(s=a.h+h,m=Math.round(c.width*(s/c.height))+h)):a.w<a.h&&(m=Math.round(c.width*(a.h/c.height))+h,s=a.h+h,m<a.w&&(m=a.w+h,s=Math.round(c.height*(m/c.width))+h));isImageUnclear(c.width,c.height,m,s,b);n.drawImage(c,0,0,c.width,c.height,a.x+h,a.y+h,m,s);a.oImg=n.getImageData(r+h,k+h,p+h,q+h);n.fillStyle="rgba(0, 0, 0, 0.5)";n.fillRect(a.x+h,a.y+h,m,s);
n.strokeStyle="#fff";n.lineWidth=h;n.strokeRect(a.x-a.iCSize[0],a.y-a.iCSize[0],m+2*h+2*a.iCSize[0],s+2*h+2*a.iCSize[0]);var d=$("<canvas>"),g=$("<canvas>");g.attr("id","clipper.temp");g[0].setAttribute("style","position: absolute; z-index:1002; pointer-events: none");g[0].style.top=k+h+"px";g[0].style.left=r+h+"px";g[0].width=p+h;g[0].height=q+h;d[0].width=p+h;d[0].height=q+h;var j=d[0].getContext("2d"),l=g[0].getContext("2d");j.putImageData(a.oImg,0,0);0<=e.attr("class").indexOf("layout_circle")?
cirClipper(l,d[0],p):0<=e.attr("class").indexOf("layout_square")&&boxClipper(l,d[0],p,q);"undefined"!=typeof e.next()[0]&&"canvas"==e.next()[0].tagName.toLowerCase()&&(e.next()[0]=null,e.next().remove());e.after(g);n.fillStyle="#fff";n.drawImage(bMove,a.x-2*a.iCSize[0],a.y-2*a.iCSize[0],2*a.iCSize[0],2*a.iCSize[0]);n.drawImage(bZoom,a.x+m+2*h,a.y-2*a.iCSize[1],2*a.iCSize[1],2*a.iCSize[1]);n.drawImage(bSave,a.x+m+2*h,a.y+s+2*h,2*a.iCSize[2],2*a.iCSize[2]);n.drawImage(bRemove,a.x-2*a.iCSize[3],a.y+
s+2*h,2*a.iCSize[3],2*a.iCSize[3])};IS_UNCLEAR="true"==b.children(".draggable").data("is_unclear")?!0:!1;$("body").append('<div class="modalOverlay"></div>');u=$(".modalOverlay");l=$("<canvas>");l[0].width=Math.round(parseInt($("body").css("width"),10));l[0].height=Math.round(parseInt($(document).height(),10));l.css("position","absolute");l.css("left","0px");l.css("top","0px");l.css("z-index","1001");$("body").append(l);e=b.clone();e.removeClass("ui-droppable");e.css("z-index","1003");e.css("opacity",
1);e.css("cursor","default");e.css("pointer-events","none");$("body").append(e);n=l[0].getContext("2d");if("undefined"!=typeof b.children(".draggable").data("zdx"))a=new t(Math.round(parseInt(b.css("left"),10))-b.children(".draggable").data("zdx"),Math.round(parseInt(b.css("top"),10))-b.children(".draggable").data("zdy"),b.children(".draggable").data("zw")-h,b.children(".draggable").data("zh")-h);else{var v,w,x,y;p>=q?(v=p,w=Math.round(c.height*(p/c.width)),w<q&&(w=q,v=Math.round(c.width*(q/c.height)))):
p<q&&(v=Math.round(c.width*(q/c.height)),w=q,v<p&&(v=p,w=Math.round(c.height*(v/c.width))));v>w?(x=r-Math.round((v-p)/2),y=k):w>v?(x=r,y=k-Math.round((w-q)/2)):(x=r,y=k);a=new t(x,y,v,w)}d();l.mousemove(function(b){var c=$(l).offset();g=Math.floor(b.pageX-c.left);j=Math.floor(b.pageY-c.top);if(a.bDragAll||a.bDrag[0])$("body").css("cursor","move"),a.x=g-a.px,a.x>=r&&(a.x=r),a.x+m<=r+p+h+h&&(a.x=r+p+h-m),a.y=j-a.py,a.y>=k&&(a.y=k),a.y+s<=k+q+h+h&&(a.y=k+q+h-s);for(i=0;4>i;i++)a.bHow[i]=!1,a.iCSize[i]=
a.csize;g>a.x-2*a.csize&&g<a.x&&j>a.y-2*a.csize&&j<a.y?($("body").css("cursor","move"),a.bHow[0]=!0):g>a.x+m&&g<a.x+m+2*a.csize&&j>a.y-2*a.csize&&j<a.y?($("body").css("cursor","sw-resize"),a.bHow[1]=!0):g>a.x+m&&g<a.x+m+2*a.csize&&j>a.y+s&&j<a.y+s+2*a.csize?($("body").css("cursor","pointer"),a.bHow[2]=!0):g>a.x-2*a.csize&&g<a.x&&j>a.y+s&&j<a.y+s+2*a.csize?($("body").css("cursor","pointer"),a.bHow[3]=!0):$("body").css("cursor","default");if(a.bDrag[1]){$("body").css("cursor","sw-resize");c=a.x+m/2;
b=a.y+s/2;var e=g-c,f=j-b;0>e&&(e=-e);0>f&&(f=-f);f=(e+f)/(m+s);f/=z;e=Math.round(m*f);f=Math.round(s*f);c=Math.round(c-e/2);b=Math.round(b-f/2);a.w=e<p?p:e;a.h=f<q?q:f;a.x=c>r?r:c+e<r+p?r+p-e:c;a.y=b>k?k:b+f<k+q?k+q-f:b}d()});l.mousedown(function(b){var c=$(l).offset();g=Math.floor(b.pageX-c.left);j=Math.floor(b.pageY-c.top);a.px=g-a.x;a.py=j-a.y;a.bHow[0]&&(a.px=g-a.x,a.py=j-a.y);a.bHow[1]&&(a.px=g-a.x-a.w,a.py=j-a.y,b=g-(a.x+m/2),c=j-(a.y+s/2),0>b&&(b=-b),0>c&&(c=-c),z=(b+c)/(m+s));a.bHow[2]&&
(a.px=g-a.x-a.w,a.py=j-a.y-a.h);a.bHow[3]&&(a.px=g-a.x,a.py=j-a.y-a.h);if(g>a.x&&g<a.x+a.w||j>a.y&&j<a.y+a.h)a.bDragAll=!0;for(i=0;4>i;i++)a.bHow[i]&&(a.bDrag[i]=!0)});l.mouseup(function(){a.bDragAll=!1;$("body").css("cursor","default");for(i=0;4>i;i++)a.bDrag[i]=!1;a.px=0;a.py=0});l.dblclick(function(b){var c=$(l).offset();g=Math.floor(b.pageX-c.left);j=Math.floor(b.pageY-c.top);(g<a.x-a.csize||g>a.x+a.w+a.csize||j<a.y-a.csize||j>a.y+a.h+a.csize)&&f()});l.click(function(c){var d=$(l).offset();g=
Math.floor(c.pageX-d.left);j=Math.floor(c.pageY-d.top);g>a.x-2*a.csize&&(g<a.x+2*a.csize&&j>a.y+s-2*a.csize&&j<a.y+s+2*a.csize)&&(l.unbind(),e.unbind(),l.remove(),l[0]=null,u.remove(),u[0]=null,e.next().remove(),e.next()[0]=null,e.remove(),e[0]=null,b.children(".draggable").each(function(){$(this)[0]=null;$(this).remove()}),b.removeData("zdx"),b.removeData("zdy"),b.removeData("zw"),b.removeData("zh"),b.css("cursor","default"),"canvas_appended"==b.next().attr("class")&&"canvas"==b.next()[0].tagName.toLowerCase()&&
(b.next()[0]=null,b.next().remove()),b.removeClass("removed"),b.css("z-index","998"));g>a.x+m-2*a.csize&&(g<a.x+m+2*a.csize&&j>a.y+s-2*a.csize&&j<a.y+s+2*a.csize)&&f()})}
function autoCentered(b,c){function t(a,b,c,d){this.x=a;this.y=b;this.w=c;this.h=d;this.px=a;this.py=b;this.csize=15;this.bHow=[!1,!1,!1,!1];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[!1,!1,!1,!1];this.bDragAll=!1;this.oImg=null}var d,f,a,l=Math.round(parseInt(b.css("left"),10)),n=Math.round(parseInt(b.css("top"),10)),g=Math.round(parseInt(b.css("width"),10)),j=Math.round(parseInt(b.css("height"),10)),r,k=Math.round(parseInt(b.css("border-left-width"),10)),p,q;t.prototype.draw=
function(){d.w>=d.h?(p=d.w+k,q=Math.round(c.height*(d.w/c.width))+k,q<d.h&&(q=d.h+k,p=Math.round(c.width*(q/c.height))+k)):d.w<d.h&&(p=Math.round(c.width*(d.h/c.height))+k,q=d.h+k,p<d.w&&(p=d.w+k,q=Math.round(c.height*(p/c.width))+k));isImageUnclear(c.width,c.height,p,q,b);a.drawImage(c,0,0,c.width,c.height,d.x+k,d.y+k,p,q);d.oImg=a.getImageData(l+k,n+k,g+k,j+k);a.fillStyle="rgba(0, 0, 0, 0.5)";a.fillRect(d.x+k,d.y+k,p,q);a.strokeStyle="#fff";a.lineWidth=k;a.strokeRect(d.x-d.iCSize[0],d.y-d.iCSize[0],
p+2*k+2*d.iCSize[0],q+2*k+2*d.iCSize[0]);var e=$("<canvas>"),f=$("<canvas>");f.attr("id","clipper.temp.auto");f[0].setAttribute("style","position: absolute; z-index:1002;");f[0].style.top=n+k+"px";f[0].style.left=l+k+"px";f[0].width=g+k;f[0].height=j+k;e[0].width=g+k;e[0].height=j+k;var h=e[0].getContext("2d"),m=f[0].getContext("2d");h.putImageData(d.oImg,0,0);0<=r.attr("class").indexOf("layout_circle")?cirClipper(m,e[0],g):0<=r.attr("class").indexOf("layout_square")&&boxClipper(m,e[0],g,j);"undefined"!=
typeof r.next()[0]&&"canvas"==r.next()[0].tagName.toLowerCase()&&(r.next()[0]=null,r.next().remove());r.after(f)};IS_UNCLEAR="true"==b.children(".draggable").data("is_unclear")?!0:!1;f=$("<canvas>");f[0].width=Math.round(parseInt($("body").css("width"),10));f[0].height=Math.round(parseInt($(document).height(),10));f.css("position","absolute");f.css("left","0px");f.css("top","0px");f.css("z-index","1001");$("body").append(f);r=b.clone();r.css("z-index","1003");r.css("opacity",1);$("body").append(r);
a=f[0].getContext("2d");if("undefined"!=typeof b.children(".draggable").data("zdx"))d=new t(Math.round(parseInt(b.css("left"),10))-b.children(".draggable").data("zdx"),Math.round(parseInt(b.css("top"),10))-b.children(".draggable").data("zdy"),b.children(".draggable").data("zw")-k,b.children(".draggable").data("zh")-k);else{var e,u,h,m;g>=j?(e=g,u=Math.round(c.height*(g/c.width)),u<j&&(u=j,e=Math.round(c.width*(j/c.height)))):g<j&&(e=Math.round(c.width*(j/c.height)),u=j,e<g&&(e=g,u=Math.round(c.height*
(e/c.width))));e>u?(h=l-Math.round((e-g)/2),m=n):u>e?(h=l,m=n-Math.round((u-j)/2)):g>j?(h=l,m=n-Math.round((u-j)/2)):(h=g<j?l-Math.round((e-g)/2):l,m=n);d=new t(h,m,e,u)}a.clearRect(-d.csize/2,-d.csize/2,a.canvas.width+d.csize,a.canvas.height+d.csize);d.draw();"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove());0<=b.attr("class").indexOf("layout_circle")?(e=$("<canvas>"),e[0].width=g+k,e[0].height=j+k,u=e[0].getContext("2d"),u.putImageData(d.oImg,0,0),doClipping(doMasking(e[0],
maskImg,b,layout_ox,layout_oy),b,cirClipper)):0<=b.attr("class").indexOf("layout_square")&&(e=$("<canvas>"),e[0].width=g+k,e[0].height=j+k,u=e[0].getContext("2d"),u.putImageData(d.oImg,0,0),doClipping(doMasking(e[0],maskImg,b,layout_ox,layout_oy),b,boxClipper));b.next().mouseenter(function(){$(".layout_corner").css("z-index","996");$(this).prev().css("z-index","998")});b.children(".draggable").data("zdx",l-d.x);b.children(".draggable").data("zdy",n-d.y);b.children(".draggable").data("zw",p);b.children(".draggable").data("zh",
q);f.unbind();r.unbind();f.remove();f[0]=null;r.next().remove();r.next()[0]=null;r.remove();r[0]=null;$("body").css("cursor","default")};