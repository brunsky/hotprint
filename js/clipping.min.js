var UNCLEAR_DETECTING=!0,IS_UNCLEAR=!1;
function isImageUnclear(b,c,t,d,e){if(!1==IS_UNCLEAR){if(t>b||d>c)IS_UNCLEAR=!0,$warning=$("<div></div>"),$warning.addClass("warning"+e.attr("id")),$warning.addClass("warning"),$warning.css("position","absolute"),$warning.css("top",e.css("top")),$warning.css("left",e.css("left")),$warning.css("z-index","998"),$warning.html('<img src="../css/images/warning.png" />'),$warning.children("img")[0].width=32,$warning.children("img")[0].height=32,$("body").append($warning),0>=$(".warning_big").length&&($warning_big=
$("<div class='warning_big'></div>"),$warning_big.css("position","absolute"),$warning_big.css("top",20+layout_oy+"px"),$warning_big.css("left",370+layout_ox+"px"),$warning_big.html('<img src="../css/images/warning.png" align="absmiddle"><span style="font-size: 16px; color: grey">\u6ce8\u610f\uff01\u6709\u4e9b\u5716\u7247\u53ef\u80fd\u5df2\u7d93\u5931\u771f\u56c9</span></img>'),$("body").append($warning_big))}else!0==IS_UNCLEAR&&(t<=b&&d<=c)&&(IS_UNCLEAR=!1,removeUnclearWarning(e.attr("id")))}
function removeUnclearWarning(b){$(".warning"+b).remove();0<$(".warning_big").length&&0>=$(".warning").length&&$(".warning_big").remove()}function autoClipper(b,c){var t=$("<canvas>"),d=t[0].getContext("2d");IS_UNCLEAR=!1;t[0].width=$(b).data("zw");t[0].height=$(b).data("zh");d.drawImage(b,0,0,$(b).data("zw"),$(b).data("zh"));c[0].getContext("2d").putImageData(d.getImageData($(b).data("zdx"),$(b).data("zdy"),c[0].width,c[0].height),0,0)}function max(b,c){return b>=c?b:c}
function autoClipper2(b,c,t,d){var e=Math.round(parseInt(d.css("border-left-width"),10)),a=Math.round(parseInt(d.css("width"),10))+e,l=Math.round(parseInt(d.css("height"),10))+e,n=Math.round(parseInt(t.css("width"),10))+e;t=Math.round(parseInt(t.css("height"),10))+e;var g=max(a,l)/max(n,t),n=Math.round($(b).data("zw")*g);t=Math.round($(b).data("zh")*g);n<c[0].width&&(n=Math.round(c[0].width)+e,t=Math.round($(b).data("zh")*(n/$(b).data("zw")))+e);t<c[0].height&&(t=Math.round(c[0].height)+e,n=Math.round($(b).data("zw")*
(t/$(b).data("zh")))+e);!0==UNCLEAR_DETECTING&&("true"==$(b).data("is_unclear")?(console.log("\u6b64\u5716\u5df2\u5931\u771f"),IS_UNCLEAR=!0):IS_UNCLEAR=!1,e=new Image,e.src=d.children(".draggable").attr("src"),isImageUnclear(e.width,e.height,n,t,d));$(b).data("zw",n);$(b).data("zh",t);d=Math.round($(b).data("zdx")*g);e=Math.round($(b).data("zdy")*g);t-e<l&&(e=0);n-d<a&&(d=0);$(b).data("zdx",d);$(b).data("zdy",e);a=$("<canvas>");l=a[0].getContext("2d");a[0].width=$(b).data("zw");a[0].height=$(b).data("zh");
l.drawImage(b,0,0,$(b).data("zw"),$(b).data("zh"));c[0].getContext("2d").putImageData(l.getImageData($(b).data("zdx"),$(b).data("zdy"),c[0].width,c[0].height),0,0)}var bMove=new Image;bMove.src="css/images/move.png";var bZoom=new Image;bZoom.src="css/images/zoom.png";var bSave=new Image;bSave.src="css/images/ok.png";var bRemove=new Image;bRemove.src="css/images/del.png";
function realClipper(b,c){function t(a,b,c,d){this.x=a;this.y=b;this.w=c;this.h=d;this.px=a;this.py=b;this.csize=15;this.bHow=[!1,!1,!1,!1];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[!1,!1,!1,!1];this.bDragAll=!1;this.oImg=null}function d(){n.clearRect(-a.csize/2,-a.csize/2,n.canvas.width+a.csize,n.canvas.height+a.csize);a.draw()}function e(){"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove());if(0<=b.attr("class").indexOf("layout_circle")){var c=
$("<canvas>");c[0].width=p+h;c[0].height=q+h;var d=c[0].getContext("2d");d.putImageData(a.oImg,0,0);doClipping(doMasking(c[0],maskImg,b,layout_ox,layout_oy),b,cirClipper)}else 0<=b.attr("class").indexOf("layout_square")&&(c=$("<canvas>"),c[0].width=p+h,c[0].height=q+h,d=c[0].getContext("2d"),d.putImageData(a.oImg,0,0),doClipping(doMasking(c[0],maskImg,b,layout_ox,layout_oy),b,boxClipper));b.next().mouseenter(function(){$(".layout_corner").css("z-index","996");$(this).prev().css("z-index","998")});
b.children(".draggable").data("zdx",r-a.x);b.children(".draggable").data("zdy",k-a.y);b.children(".draggable").data("zw",m);b.children(".draggable").data("zh",s);l.unbind();f.unbind();l.remove();l[0]=null;u.remove();u[0]=null;f.next().remove();f.next()[0]=null;f.remove();f[0]=null;$("body").css("cursor","default")}var a,l,n,g,j=1,r=Math.round(parseInt(b.css("left"),10)),k=Math.round(parseInt(b.css("top"),10)),p=Math.round(parseInt(b.css("width"),10)),q=Math.round(parseInt(b.css("height"),10)),f,u,
h=Math.round(parseInt(b.css("border-left-width"),10)),m,s,z;t.prototype.draw=function(){a.w>=a.h?(m=a.w+h,s=Math.round(c.height*(a.w/c.width))+h,s<a.h&&(s=a.h+h,m=Math.round(c.width*(s/c.height))+h)):a.w<a.h&&(m=Math.round(c.width*(a.h/c.height))+h,s=a.h+h,m<a.w&&(m=a.w+h,s=Math.round(c.height*(m/c.width))+h));isImageUnclear(c.width,c.height,m,s,b);n.drawImage(c,0,0,c.width,c.height,a.x+h,a.y+h,m,s);a.oImg=n.getImageData(r+h,k+h,p+h,q+h);n.fillStyle="rgba(0, 0, 0, 0.5)";n.fillRect(a.x+h,a.y+h,m,s);
n.strokeStyle="#fff";n.lineWidth=h;n.strokeRect(a.x-a.iCSize[0],a.y-a.iCSize[0],m+2*h+2*a.iCSize[0],s+2*h+2*a.iCSize[0]);var d=$("<canvas>"),g=$("<canvas>");g.attr("id","clipper.temp");g[0].setAttribute("style","position: absolute; z-index:1002;");g[0].style.top=k+h+"px";g[0].style.left=r+h+"px";g[0].width=p+h;g[0].height=q+h;d[0].width=p+h;d[0].height=q+h;var j=d[0].getContext("2d"),l=g[0].getContext("2d");j.putImageData(a.oImg,0,0);0<=f.attr("class").indexOf("layout_circle")?cirClipper(l,d[0],p):
0<=f.attr("class").indexOf("layout_square")&&boxClipper(l,d[0],p,q);"undefined"!=typeof f.next()[0]&&"canvas"==f.next()[0].tagName.toLowerCase()&&(f.next()[0]=null,f.next().remove());f.after(g);n.fillStyle="#fff";n.drawImage(bMove,a.x-2*a.iCSize[0],a.y-2*a.iCSize[0],2*a.iCSize[0],2*a.iCSize[0]);n.drawImage(bZoom,a.x+m+2*h,a.y-2*a.iCSize[1],2*a.iCSize[1],2*a.iCSize[1]);n.drawImage(bSave,a.x+m+2*h,a.y+s+2*h,2*a.iCSize[2],2*a.iCSize[2]);n.drawImage(bRemove,a.x-2*a.iCSize[3],a.y+s+2*h,2*a.iCSize[3],2*
a.iCSize[3])};"true"==b.children(".draggable").data("is_unclear")?(console.log("\u6b64\u5716\u5df2\u5931\u771f"),IS_UNCLEAR=!0):IS_UNCLEAR=!1;$("body").append('<div class="modalOverlay"></div>');u=$(".modalOverlay");l=$("<canvas>");l[0].width=Math.round(parseInt($("body").css("width"),10));l[0].height=Math.round(parseInt($(document).height(),10));l.css("position","absolute");l.css("left","0px");l.css("top","0px");l.css("z-index","1001");$("body").append(l);f=b.clone();f.removeClass("ui-droppable");
f.css("z-index","1003");f.css("opacity",1);f.css("cursor","default");$("body").append(f);n=l[0].getContext("2d");if("undefined"!=typeof b.children(".draggable").data("zdx"))a=new t(Math.round(parseInt(b.css("left"),10))-b.children(".draggable").data("zdx"),Math.round(parseInt(b.css("top"),10))-b.children(".draggable").data("zdy"),b.children(".draggable").data("zw")-h,b.children(".draggable").data("zh")-h);else{var v,w,x,y;p>=q?(v=p,w=Math.round(c.height*(p/c.width)),w<q&&(w=q,v=Math.round(c.width*
(q/c.height)))):p<q&&(v=Math.round(c.width*(q/c.height)),w=q,v<p&&(v=p,w=Math.round(c.height*(v/c.width))));v>w?(x=r-Math.round((v-p)/2),y=k):w>v?(x=r,y=k-Math.round((w-q)/2)):(x=r,y=k);a=new t(x,y,v,w)}d();l.mousemove(function(b){var c=$(l).offset();g=Math.floor(b.pageX-c.left);j=Math.floor(b.pageY-c.top);if(a.bDragAll||a.bDrag[0])$("body").css("cursor","move"),a.x=g-a.px,a.x>=r&&(a.x=r),a.x+m<=r+p+h+h&&(a.x=r+p+h-m),a.y=j-a.py,a.y>=k&&(a.y=k),a.y+s<=k+q+h+h&&(a.y=k+q+h-s);for(i=0;4>i;i++)a.bHow[i]=
!1,a.iCSize[i]=a.csize;g>a.x-2*a.csize&&g<a.x&&j>a.y-2*a.csize&&j<a.y?($("body").css("cursor","move"),a.bHow[0]=!0):g>a.x+m&&g<a.x+m+2*a.csize&&j>a.y-2*a.csize&&j<a.y?($("body").css("cursor","sw-resize"),a.bHow[1]=!0):g>a.x+m&&g<a.x+m+2*a.csize&&j>a.y+s&&j<a.y+s+2*a.csize?($("body").css("cursor","pointer"),a.bHow[2]=!0):g>a.x-2*a.csize&&g<a.x&&j>a.y+s&&j<a.y+s+2*a.csize?($("body").css("cursor","pointer"),a.bHow[3]=!0):$("body").css("cursor","default");if(a.bDrag[1]){$("body").css("cursor","sw-resize");
c=a.x+m/2;b=a.y+s/2;var f=g-c,e=j-b;0>f&&(f=-f);0>e&&(e=-e);e=(f+e)/(m+s);e/=z;f=Math.round(m*e);e=Math.round(s*e);c=Math.round(c-f/2);b=Math.round(b-e/2);a.w=f<p?p:f;a.h=e<q?q:e;a.x=c>r?r:c+f<r+p?r+p-f:c;a.y=b>k?k:b+e<k+q?k+q-e:b}d()});l.mousedown(function(b){var c=$(l).offset();g=Math.floor(b.pageX-c.left);j=Math.floor(b.pageY-c.top);a.px=g-a.x;a.py=j-a.y;a.bHow[0]&&(a.px=g-a.x,a.py=j-a.y);a.bHow[1]&&(a.px=g-a.x-a.w,a.py=j-a.y,b=g-(a.x+m/2),c=j-(a.y+s/2),0>b&&(b=-b),0>c&&(c=-c),z=(b+c)/(m+s));a.bHow[2]&&
(a.px=g-a.x-a.w,a.py=j-a.y-a.h);a.bHow[3]&&(a.px=g-a.x,a.py=j-a.y-a.h);g>a.x&&(g<a.x+a.w&&j>a.y&&j<a.y+a.h)&&(a.bDragAll=!0);for(i=0;4>i;i++)a.bHow[i]&&(a.bDrag[i]=!0)});l.mouseup(function(){a.bDragAll=!1;$("body").css("cursor","default");for(i=0;4>i;i++)a.bDrag[i]=!1;a.px=0;a.py=0});l.dblclick(function(b){var c=$(l).offset();g=Math.floor(b.pageX-c.left);j=Math.floor(b.pageY-c.top);(g<a.x-a.csize||g>a.x+a.w+a.csize||j<a.y-a.csize||j>a.y+a.h+a.csize)&&e()});l.click(function(c){var d=$(l).offset();
g=Math.floor(c.pageX-d.left);j=Math.floor(c.pageY-d.top);g>a.x-2*a.csize&&(g<a.x+2*a.csize&&j>a.y+s-2*a.csize&&j<a.y+s+2*a.csize)&&(l.unbind(),f.unbind(),l.remove(),l[0]=null,u.remove(),u[0]=null,f.next().remove(),f.next()[0]=null,f.remove(),f[0]=null,b.children(".draggable").each(function(){$(this)[0]=null;$(this).remove()}),b.removeData("zdx"),b.removeData("zdy"),b.removeData("zw"),b.removeData("zh"),b.css("cursor","default"),"canvas_appended"==b.next().attr("class")&&"canvas"==b.next()[0].tagName.toLowerCase()&&
(b.next()[0]=null,b.next().remove()),b.removeClass("removed"),b.css("z-index","998"));g>a.x+m-2*a.csize&&(g<a.x+m+2*a.csize&&j>a.y+s-2*a.csize&&j<a.y+s+2*a.csize)&&e()})}
function autoCentered(b,c){function t(a,b,c,d){this.x=a;this.y=b;this.w=c;this.h=d;this.px=a;this.py=b;this.csize=15;this.bHow=[!1,!1,!1,!1];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[!1,!1,!1,!1];this.bDragAll=!1;this.oImg=null}var d,e,a,l=Math.round(parseInt(b.css("left"),10)),n=Math.round(parseInt(b.css("top"),10)),g=Math.round(parseInt(b.css("width"),10)),j=Math.round(parseInt(b.css("height"),10)),r,k=Math.round(parseInt(b.css("border-left-width"),10)),p,q;t.prototype.draw=
function(){d.w>=d.h?(p=d.w+k,q=Math.round(c.height*(d.w/c.width))+k,q<d.h&&(q=d.h+k,p=Math.round(c.width*(q/c.height))+k)):d.w<d.h&&(p=Math.round(c.width*(d.h/c.height))+k,q=d.h+k,p<d.w&&(p=d.w+k,q=Math.round(c.height*(p/c.width))+k));isImageUnclear(c.width,c.height,p,q,b);a.drawImage(c,0,0,c.width,c.height,d.x+k,d.y+k,p,q);d.oImg=a.getImageData(l+k,n+k,g+k,j+k);a.fillStyle="rgba(0, 0, 0, 0.5)";a.fillRect(d.x+k,d.y+k,p,q);a.strokeStyle="#fff";a.lineWidth=k;a.strokeRect(d.x-d.iCSize[0],d.y-d.iCSize[0],
p+2*k+2*d.iCSize[0],q+2*k+2*d.iCSize[0]);var f=$("<canvas>"),e=$("<canvas>");e.attr("id","clipper.temp.auto");e[0].setAttribute("style","position: absolute; z-index:1002;");e[0].style.top=n+k+"px";e[0].style.left=l+k+"px";e[0].width=g+k;e[0].height=j+k;f[0].width=g+k;f[0].height=j+k;var h=f[0].getContext("2d"),m=e[0].getContext("2d");h.putImageData(d.oImg,0,0);0<=r.attr("class").indexOf("layout_circle")?cirClipper(m,f[0],g):0<=r.attr("class").indexOf("layout_square")&&boxClipper(m,f[0],g,j);"undefined"!=
typeof r.next()[0]&&"canvas"==r.next()[0].tagName.toLowerCase()&&(r.next()[0]=null,r.next().remove());r.after(e)};"true"==b.children(".draggable").data("is_unclear")?(console.log("\u6b64\u5716\u5df2\u5931\u771f"),IS_UNCLEAR=!0):IS_UNCLEAR=!1;e=$("<canvas>");e[0].width=Math.round(parseInt($("body").css("width"),10));e[0].height=Math.round(parseInt($(document).height(),10));e.css("position","absolute");e.css("left","0px");e.css("top","0px");e.css("z-index","1001");$("body").append(e);r=b.clone();r.css("z-index",
"1003");r.css("opacity",1);$("body").append(r);a=e[0].getContext("2d");if("undefined"!=typeof b.children(".draggable").data("zdx"))d=new t(Math.round(parseInt(b.css("left"),10))-b.children(".draggable").data("zdx"),Math.round(parseInt(b.css("top"),10))-b.children(".draggable").data("zdy"),b.children(".draggable").data("zw")-k,b.children(".draggable").data("zh")-k);else{var f,u,h,m;g>=j?(f=g,u=Math.round(c.height*(g/c.width)),u<j&&(u=j,f=Math.round(c.width*(j/c.height)))):g<j&&(f=Math.round(c.width*
(j/c.height)),u=j,f<g&&(f=g,u=Math.round(c.height*(f/c.width))));f>u?(h=l-Math.round((f-g)/2),m=n):u>f?(h=l,m=n-Math.round((u-j)/2)):g>j?(h=l,m=n-Math.round((u-j)/2)):(h=g<j?l-Math.round((f-g)/2):l,m=n);d=new t(h,m,f,u)}a.clearRect(-d.csize/2,-d.csize/2,a.canvas.width+d.csize,a.canvas.height+d.csize);d.draw();"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove());0<=b.attr("class").indexOf("layout_circle")?(f=$("<canvas>"),f[0].width=g+k,f[0].height=j+k,u=f[0].getContext("2d"),
u.putImageData(d.oImg,0,0),doClipping(doMasking(f[0],maskImg,b,layout_ox,layout_oy),b,cirClipper)):0<=b.attr("class").indexOf("layout_square")&&(f=$("<canvas>"),f[0].width=g+k,f[0].height=j+k,u=f[0].getContext("2d"),u.putImageData(d.oImg,0,0),doClipping(doMasking(f[0],maskImg,b,layout_ox,layout_oy),b,boxClipper));b.next().mouseenter(function(){$(".layout_corner").css("z-index","996");$(this).prev().css("z-index","998")});b.children(".draggable").data("zdx",l-d.x);b.children(".draggable").data("zdy",
n-d.y);b.children(".draggable").data("zw",p);b.children(".draggable").data("zh",q);e.unbind();r.unbind();e.remove();e[0]=null;r.next().remove();r.next()[0]=null;r.remove();r[0]=null;$("body").css("cursor","default")};