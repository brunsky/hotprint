function autoClipper(b,d){var l=$("<canvas>"),n=l[0].getContext("2d");l[0].width=$(b).data("zw");l[0].height=$(b).data("zh");n.drawImage(b,0,0,$(b).data("zw"),$(b).data("zh"));d[0].getContext("2d").putImageData(n.getImageData($(b).data("zdx"),$(b).data("zdy"),d[0].width,d[0].height),0,0)}function max(b,d){return b>=d?b:d}
function autoClipper2(b,d,l,n){var p=Math.round(parseInt(n.css("border-left-width"),10)),x=Math.round(parseInt(n.css("width"),10))+p;n=Math.round(parseInt(n.css("height"),10))+p;var v=Math.round(parseInt(l.css("width"),10))+p;l=Math.round(parseInt(l.css("height"),10))+p;var w=max(x,n)/max(v,l);l=Math.round($(b).data("zw")*w);v=Math.round($(b).data("zh")*w);l<d[0].width&&(l=Math.round(d[0].width)+p,v=Math.round($(b).data("zh")*(l/$(b).data("zw")))+p);v<d[0].height&&(v=Math.round(d[0].height)+p,l=Math.round($(b).data("zw")*
(v/$(b).data("zh")))+p);$(b).data("zw",l);$(b).data("zh",v);p=Math.round($(b).data("zdx")*w);w=Math.round($(b).data("zdy")*w);v-w<n&&(w=0);l-p<x&&(p=0);$(b).data("zdx",p);$(b).data("zdy",w);x=$("<canvas>");n=x[0].getContext("2d");x[0].width=$(b).data("zw");x[0].height=$(b).data("zh");n.drawImage(b,0,0,$(b).data("zw"),$(b).data("zh"));d[0].getContext("2d").putImageData(n.getImageData($(b).data("zdx"),$(b).data("zdy"),d[0].width,d[0].height),0,0)}var bMove=new Image;bMove.src="css/images/move.png";
var bZoom=new Image;bZoom.src="css/images/zoom.png";var bSave=new Image;bSave.src="css/images/ok.png";var bRemove=new Image;bRemove.src="css/images/del.png";
function realClipper(b,d){function l(a,b,c,f){this.x=a;this.y=b;this.w=c;this.h=f;this.px=a;this.py=b;this.csize=15;this.bHow=[!1,!1,!1,!1];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[!1,!1,!1,!1];this.bDragAll=!1;this.oImg=null}function n(){m.clearRect(-a.csize/2,-a.csize/2,m.canvas.width+a.csize,m.canvas.height+a.csize);a.draw()}function p(){"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove());if(0<=b.attr("class").indexOf("layout_circle")){var y=
$("<canvas>");y[0].width=q+c;y[0].height=s+c;var r=y[0].getContext("2d");r.putImageData(a.oImg,0,0);doClipping(doMasking(y[0],maskImg,b,layout_ox,layout_oy),b,cirClipper)}else 0<=b.attr("class").indexOf("layout_square")&&(y=$("<canvas>"),y[0].width=q+c,y[0].height=s+c,r=y[0].getContext("2d"),r.putImageData(a.oImg,0,0),doClipping(doMasking(y[0],maskImg,b,layout_ox,layout_oy),b,boxClipper));b.next().mouseenter(function(){$(".layout_corner").css("z-index","996");$(this).prev().css("z-index","998")});
b.children(".draggable").data("zdx",t-a.x);b.children(".draggable").data("zdy",u-a.y);b.children(".draggable").data("zw",k);b.children(".draggable").data("zh",h);j.unbind();e.unbind();j.remove();j[0]=null;z.remove();z[0]=null;e.next().remove();e.next()[0]=null;e.remove();e[0]=null;$("body").css("cursor","default")}function x(b){var r=$(j).offset();f=Math.floor(b.pageX-r.left);g=Math.floor(b.pageY-r.top);if(a.bDragAll||a.bDrag[0])$("body").css("cursor","move"),a.x=f-a.px,a.x>=t&&(a.x=t),a.x+k<=t+q+
c+c&&(a.x=t+q+c-k),a.y=g-a.py,a.y>=u&&(a.y=u),a.y+h<=u+s+c+c&&(a.y=u+s+c-h);for(i=0;4>i;i++)a.bHow[i]=!1,a.iCSize[i]=a.csize;f>a.x-2*a.csize&&f<a.x&&g>a.y-2*a.csize&&g<a.y?($("body").css("cursor","move"),a.bHow[0]=!0):f>a.x+k&&f<a.x+k+2*a.csize&&g>a.y-2*a.csize&&g<a.y?($("body").css("cursor","sw-resize"),a.bHow[1]=!0):f>a.x+k&&f<a.x+k+2*a.csize&&g>a.y+h&&g<a.y+h+2*a.csize?($("body").css("cursor","pointer"),a.bHow[2]=!0):f>a.x-2*a.csize&&f<a.x&&g>a.y+h&&g<a.y+h+2*a.csize?($("body").css("cursor","pointer"),
a.bHow[3]=!0):$("body").css("cursor","default");if(a.bDrag[1]){$("body").css("cursor","sw-resize");r=a.x+k/2;b=a.y+h/2;var d=f-r,e=g-b;0>d&&(d=-d);0>e&&(e=-e);e=(d+e)/(k+h);e/=A;d=Math.round(k*e);e=Math.round(h*e);r=Math.round(r-d/2);b=Math.round(b-e/2);a.w=d<q?q:d;a.h=e<s?s:e;a.x=r>t?t:r+d<t+q?t+q-d:r;a.y=b>u?u:b+e<u+s?u+s-e:b}n()}function v(b){var c=$(j).offset();f=Math.floor(b.pageX-c.left);g=Math.floor(b.pageY-c.top);a.px=f-a.x;a.py=g-a.y;a.bHow[0]&&(a.px=f-a.x,a.py=g-a.y);a.bHow[1]&&(a.px=f-
a.x-a.w,a.py=g-a.y,b=f-(a.x+k/2),c=g-(a.y+h/2),0>b&&(b=-b),0>c&&(c=-c),A=(b+c)/(k+h));a.bHow[2]&&(a.px=f-a.x-a.w,a.py=g-a.y-a.h);a.bHow[3]&&(a.px=f-a.x,a.py=g-a.y-a.h);f>a.x&&(f<a.x+a.w&&g>a.y&&g<a.y+a.h)&&(a.bDragAll=!0);for(i=0;4>i;i++)a.bHow[i]&&(a.bDrag[i]=!0)}function w(){a.bDragAll=!1;$("body").css("cursor","default");for(i=0;4>i;i++)a.bDrag[i]=!1;a.px=0;a.py=0}var a,j,m,f,g=1,t=Math.round(parseInt(b.css("left"),10)),u=Math.round(parseInt(b.css("top"),10)),q=Math.round(parseInt(b.css("width"),
10)),s=Math.round(parseInt(b.css("height"),10)),e,z,c=Math.round(parseInt(b.css("border-left-width"),10)),k,h,A;l.prototype.draw=function(){a.w>=a.h?(k=a.w+c,h=Math.round(d.height*(a.w/d.width))+c,h<a.h&&(h=a.h+c,k=Math.round(d.width*(h/d.height))+c)):a.w<a.h&&(k=Math.round(d.width*(a.h/d.height))+c,h=a.h+c,k<a.w&&(k=a.w+c,h=Math.round(d.height*(k/d.width))+c));m.drawImage(d,0,0,d.width,d.height,a.x+c,a.y+c,k,h);a.oImg=m.getImageData(t+c,u+c,q+c,s+c);m.fillStyle="rgba(0, 0, 0, 0.5)";m.fillRect(a.x+
c,a.y+c,k,h);m.strokeStyle="#fff";m.lineWidth=c;m.strokeRect(a.x-a.iCSize[0],a.y-a.iCSize[0],k+2*c+2*a.iCSize[0],h+2*c+2*a.iCSize[0]);var b=$("<canvas>"),f=$("<canvas>");f.attr("id","clipper.temp");f[0].setAttribute("style","position: absolute; z-index:1002;");f[0].style.top=u+c+"px";f[0].style.left=t+c+"px";f[0].width=q+c;f[0].height=s+c;b[0].width=q+c;b[0].height=s+c;var g=b[0].getContext("2d"),j=f[0].getContext("2d");g.putImageData(a.oImg,0,0);0<=e.attr("class").indexOf("layout_circle")?cirClipper(j,
b[0],q):0<=e.attr("class").indexOf("layout_square")&&boxClipper(j,b[0],q,s);"undefined"!=typeof e.next()[0]&&"canvas"==e.next()[0].tagName.toLowerCase()&&(e.next()[0]=null,e.next().remove());e.after(f);m.fillStyle="#fff";m.drawImage(bMove,a.x-2*a.iCSize[0],a.y-2*a.iCSize[0],2*a.iCSize[0],2*a.iCSize[0]);m.drawImage(bZoom,a.x+k+2*c,a.y-2*a.iCSize[1],2*a.iCSize[1],2*a.iCSize[1]);m.drawImage(bSave,a.x+k+2*c,a.y+h+2*c,2*a.iCSize[2],2*a.iCSize[2]);m.drawImage(bRemove,a.x-2*a.iCSize[3],a.y+h+2*c,2*a.iCSize[3],
2*a.iCSize[3])};$("body").append('<div class="modalOverlay"></div>');z=$(".modalOverlay");j=$("<canvas>");j[0].width=Math.round(parseInt($("body").css("width"),10));j[0].height=Math.round(parseInt($(document).height(),10));j.css("position","absolute");j.css("left","0px");j.css("top","0px");j.css("z-index","1001");$("body").append(j);e=b.clone();e.css("z-index","1003");e.css("opacity",1);$("body").append(e);e.mousemove(x);e.mousedown(v);e.mouseup(w);m=j[0].getContext("2d");a="undefined"!=typeof b.children(".draggable").data("zdx")?
new l(Math.round(parseInt(b.css("left"),10))-b.children(".draggable").data("zdx"),Math.round(parseInt(b.css("top"),10))-b.children(".draggable").data("zdy"),b.children(".draggable").data("zw")-c,b.children(".draggable").data("zh")-c):new l(t,u,q,s);n();j.mousemove(x);j.mousedown(v);j.mouseup(w);j.dblclick(function(b){var c=$(j).offset();f=Math.floor(b.pageX-c.left);g=Math.floor(b.pageY-c.top);(f<a.x-a.csize||f>a.x+a.w+a.csize||g<a.y-a.csize||g>a.y+a.h+a.csize)&&p()});j.click(function(c){var d=$(j).offset();
f=Math.floor(c.pageX-d.left);g=Math.floor(c.pageY-d.top);f>a.x-2*a.csize&&(f<a.x+2*a.csize&&g>a.y+h-2*a.csize&&g<a.y+h+2*a.csize)&&(j.unbind(),e.unbind(),j.remove(),j[0]=null,z.remove(),z[0]=null,e.next().remove(),e.next()[0]=null,e.remove(),e[0]=null,b.children(".draggable").each(function(){$(this)[0]=null;$(this).remove()}),b.removeData("zdx"),b.removeData("zdy"),b.removeData("zw"),b.removeData("zh"),b.css("cursor","default"),"canvas_appended"==b.next().attr("class")&&"canvas"==b.next()[0].tagName.toLowerCase()&&
(b.next()[0]=null,b.next().remove()),b.removeClass("removed"),b.css("z-index","998"));f>a.x+k-2*a.csize&&(f<a.x+k+2*a.csize&&g>a.y+h-2*a.csize&&g<a.y+h+2*a.csize)&&p()})};