var IS_UNCLEAR=!1,COUNTER_UNCLEAR=0;
function isImageUnclear(b,c,s,d,g){if(!1==IS_UNCLEAR){if(s>b||d>c)IS_UNCLEAR=!0,COUNTER_UNCLEAR++,$warning=$("<div></div>"),$warning.addClass("warning"+g.attr("id")),$warning.addClass("warning"),$warning.css("position","absolute"),$warning.css("top",g.css("top")),$warning.css("left",g.css("left")),$warning.css("z-index","998"),$warning.html('<img src="../css/images/warning.png" />'),$warning.children("img")[0].width=32,$warning.children("img")[0].height=32,$("body").append($warning),0>=$(".warning_big").length&&
($warning_big=$("<div></div>"),$warning.addClass("warning_big"))}else!0==IS_UNCLEAR&&(s<=b&&d<=c)&&(IS_UNCLEAR=!1,removeUnclearWarning(g.attr("id")))}function removeUnclearWarning(b){$(".warning"+b).remove();COUNTER_UNCLEAR--}
function autoClipper(b,c){var s=$("<canvas>"),d=s[0].getContext("2d");IS_UNCLEAR=!1;s[0].width=$(b).data("zw");s[0].height=$(b).data("zh");d.drawImage(b,0,0,$(b).data("zw"),$(b).data("zh"));c[0].getContext("2d").putImageData(d.getImageData($(b).data("zdx"),$(b).data("zdy"),c[0].width,c[0].height),0,0)}function max(b,c){return b>=c?b:c}
function autoClipper2(b,c,s,d){var g=Math.round(parseInt(d.css("border-left-width"),10)),a=Math.round(parseInt(d.css("width"),10))+g,l=Math.round(parseInt(d.css("height"),10))+g,p=Math.round(parseInt(s.css("width"),10))+g;s=Math.round(parseInt(s.css("height"),10))+g;var f=max(a,l)/max(p,s),p=Math.round($(b).data("zw")*f);s=Math.round($(b).data("zh")*f);p<c[0].width&&(p=Math.round(c[0].width)+g,s=Math.round($(b).data("zh")*(p/$(b).data("zw")))+g);s<c[0].height&&(s=Math.round(c[0].height)+g,p=Math.round($(b).data("zw")*
(s/$(b).data("zh")))+g);"true"==$(b).data("is_unclear")?(console.log("\u6b64\u5716\u5df2\u5931\u771f"),IS_UNCLEAR=!0):IS_UNCLEAR=!1;g=new Image;g.src=d.children(".draggable").attr("src");isImageUnclear(g.width,g.height,p,s,d);$(b).data("zw",p);$(b).data("zh",s);d=Math.round($(b).data("zdx")*f);g=Math.round($(b).data("zdy")*f);s-g<l&&(g=0);p-d<a&&(d=0);$(b).data("zdx",d);$(b).data("zdy",g);a=$("<canvas>");l=a[0].getContext("2d");a[0].width=$(b).data("zw");a[0].height=$(b).data("zh");l.drawImage(b,
0,0,$(b).data("zw"),$(b).data("zh"));c[0].getContext("2d").putImageData(l.getImageData($(b).data("zdx"),$(b).data("zdy"),c[0].width,c[0].height),0,0)}var bMove=new Image;bMove.src="css/images/move.png";var bZoom=new Image;bZoom.src="css/images/zoom.png";var bSave=new Image;bSave.src="css/images/ok.png";var bRemove=new Image;bRemove.src="css/images/del.png";
function realClipper(b,c){function s(a,b,c,e){this.x=a;this.y=b;this.w=c;this.h=e;this.px=a;this.py=b;this.csize=15;this.bHow=[!1,!1,!1,!1];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[!1,!1,!1,!1];this.bDragAll=!1;this.oImg=null}function d(){p.clearRect(-a.csize/2,-a.csize/2,p.canvas.width+a.csize,p.canvas.height+a.csize);a.draw()}function g(){"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove());if(0<=b.attr("class").indexOf("layout_circle")){var c=
$("<canvas>");c[0].width=h+e;c[0].height=q+e;var d=c[0].getContext("2d");d.putImageData(a.oImg,0,0);doClipping(doMasking(c[0],maskImg,b,layout_ox,layout_oy),b,cirClipper)}else 0<=b.attr("class").indexOf("layout_square")&&(c=$("<canvas>"),c[0].width=h+e,c[0].height=q+e,d=c[0].getContext("2d"),d.putImageData(a.oImg,0,0),doClipping(doMasking(c[0],maskImg,b,layout_ox,layout_oy),b,boxClipper));b.next().mouseenter(function(){$(".layout_corner").css("z-index","996");$(this).prev().css("z-index","998")});
b.children(".draggable").data("zdx",r-a.x);b.children(".draggable").data("zdy",u-a.y);b.children(".draggable").data("zw",n);b.children(".draggable").data("zh",m);l.unbind();j.unbind();l.remove();l[0]=null;t.remove();t[0]=null;j.next().remove();j.next()[0]=null;j.remove();j[0]=null;$("body").css("cursor","default")}var a,l,p,f,k=1,r=Math.round(parseInt(b.css("left"),10)),u=Math.round(parseInt(b.css("top"),10)),h=Math.round(parseInt(b.css("width"),10)),q=Math.round(parseInt(b.css("height"),10)),j,t,
e=Math.round(parseInt(b.css("border-left-width"),10)),n,m,z;s.prototype.draw=function(){a.w>=a.h?(n=a.w+e,m=Math.round(c.height*(a.w/c.width))+e,m<a.h&&(m=a.h+e,n=Math.round(c.width*(m/c.height))+e)):a.w<a.h&&(n=Math.round(c.width*(a.h/c.height))+e,m=a.h+e,n<a.w&&(n=a.w+e,m=Math.round(c.height*(n/c.width))+e));isImageUnclear(c.width,c.height,n,m,b);p.drawImage(c,0,0,c.width,c.height,a.x+e,a.y+e,n,m);a.oImg=p.getImageData(r+e,u+e,h+e,q+e);p.fillStyle="rgba(0, 0, 0, 0.5)";p.fillRect(a.x+e,a.y+e,n,m);
p.strokeStyle="#fff";p.lineWidth=e;p.strokeRect(a.x-a.iCSize[0],a.y-a.iCSize[0],n+2*e+2*a.iCSize[0],m+2*e+2*a.iCSize[0]);var d=$("<canvas>"),f=$("<canvas>");f.attr("id","clipper.temp");f[0].setAttribute("style","position: absolute; z-index:1002;");f[0].style.top=u+e+"px";f[0].style.left=r+e+"px";f[0].width=h+e;f[0].height=q+e;d[0].width=h+e;d[0].height=q+e;var k=d[0].getContext("2d"),l=f[0].getContext("2d");k.putImageData(a.oImg,0,0);0<=j.attr("class").indexOf("layout_circle")?cirClipper(l,d[0],h):
0<=j.attr("class").indexOf("layout_square")&&boxClipper(l,d[0],h,q);"undefined"!=typeof j.next()[0]&&"canvas"==j.next()[0].tagName.toLowerCase()&&(j.next()[0]=null,j.next().remove());j.after(f);p.fillStyle="#fff";p.drawImage(bMove,a.x-2*a.iCSize[0],a.y-2*a.iCSize[0],2*a.iCSize[0],2*a.iCSize[0]);p.drawImage(bZoom,a.x+n+2*e,a.y-2*a.iCSize[1],2*a.iCSize[1],2*a.iCSize[1]);p.drawImage(bSave,a.x+n+2*e,a.y+m+2*e,2*a.iCSize[2],2*a.iCSize[2]);p.drawImage(bRemove,a.x-2*a.iCSize[3],a.y+m+2*e,2*a.iCSize[3],2*
a.iCSize[3])};"true"==b.children(".draggable").data("is_unclear")?(console.log("\u6b64\u5716\u5df2\u5931\u771f"),IS_UNCLEAR=!0):IS_UNCLEAR=!1;$("body").append('<div class="modalOverlay"></div>');t=$(".modalOverlay");l=$("<canvas>");l[0].width=Math.round(parseInt($("body").css("width"),10));l[0].height=Math.round(parseInt($(document).height(),10));l.css("position","absolute");l.css("left","0px");l.css("top","0px");l.css("z-index","1001");$("body").append(l);j=b.clone();j.removeClass("ui-droppable");
j.css("z-index","1003");j.css("opacity",1);j.css("cursor","default");$("body").append(j);p=l[0].getContext("2d");if("undefined"!=typeof b.children(".draggable").data("zdx"))a=new s(Math.round(parseInt(b.css("left"),10))-b.children(".draggable").data("zdx"),Math.round(parseInt(b.css("top"),10))-b.children(".draggable").data("zdy"),b.children(".draggable").data("zw")-e,b.children(".draggable").data("zh")-e);else{var v,w,x,y;h>=q?(v=h,w=Math.round(c.height*(h/c.width)),w<q&&(w=q,v=Math.round(c.width*
(q/c.height)))):h<q&&(v=Math.round(c.width*(q/c.height)),w=q,v<h&&(v=h,w=Math.round(c.height*(v/c.width))));v>w?(x=r-Math.round((v-h)/2),y=u):w>v?(x=r,y=u-Math.round((w-q)/2)):(x=r,y=u);a=new s(x,y,v,w)}d();l.mousemove(function(b){var c=$(l).offset();f=Math.floor(b.pageX-c.left);k=Math.floor(b.pageY-c.top);if(a.bDragAll||a.bDrag[0])$("body").css("cursor","move"),a.x=f-a.px,a.x>=r&&(a.x=r),a.x+n<=r+h+e+e&&(a.x=r+h+e-n),a.y=k-a.py,a.y>=u&&(a.y=u),a.y+m<=u+q+e+e&&(a.y=u+q+e-m);for(i=0;4>i;i++)a.bHow[i]=
!1,a.iCSize[i]=a.csize;f>a.x-2*a.csize&&f<a.x&&k>a.y-2*a.csize&&k<a.y?($("body").css("cursor","move"),a.bHow[0]=!0):f>a.x+n&&f<a.x+n+2*a.csize&&k>a.y-2*a.csize&&k<a.y?($("body").css("cursor","sw-resize"),a.bHow[1]=!0):f>a.x+n&&f<a.x+n+2*a.csize&&k>a.y+m&&k<a.y+m+2*a.csize?($("body").css("cursor","pointer"),a.bHow[2]=!0):f>a.x-2*a.csize&&f<a.x&&k>a.y+m&&k<a.y+m+2*a.csize?($("body").css("cursor","pointer"),a.bHow[3]=!0):$("body").css("cursor","default");if(a.bDrag[1]){$("body").css("cursor","sw-resize");
c=a.x+n/2;b=a.y+m/2;var g=f-c,j=k-b;0>g&&(g=-g);0>j&&(j=-j);j=(g+j)/(n+m);j/=z;g=Math.round(n*j);j=Math.round(m*j);c=Math.round(c-g/2);b=Math.round(b-j/2);a.w=g<h?h:g;a.h=j<q?q:j;a.x=c>r?r:c+g<r+h?r+h-g:c;a.y=b>u?u:b+j<u+q?u+q-j:b}d()});l.mousedown(function(b){var c=$(l).offset();f=Math.floor(b.pageX-c.left);k=Math.floor(b.pageY-c.top);a.px=f-a.x;a.py=k-a.y;a.bHow[0]&&(a.px=f-a.x,a.py=k-a.y);a.bHow[1]&&(a.px=f-a.x-a.w,a.py=k-a.y,b=f-(a.x+n/2),c=k-(a.y+m/2),0>b&&(b=-b),0>c&&(c=-c),z=(b+c)/(n+m));a.bHow[2]&&
(a.px=f-a.x-a.w,a.py=k-a.y-a.h);a.bHow[3]&&(a.px=f-a.x,a.py=k-a.y-a.h);f>a.x&&(f<a.x+a.w&&k>a.y&&k<a.y+a.h)&&(a.bDragAll=!0);for(i=0;4>i;i++)a.bHow[i]&&(a.bDrag[i]=!0)});l.mouseup(function(){a.bDragAll=!1;$("body").css("cursor","default");for(i=0;4>i;i++)a.bDrag[i]=!1;a.px=0;a.py=0});l.dblclick(function(b){var c=$(l).offset();f=Math.floor(b.pageX-c.left);k=Math.floor(b.pageY-c.top);(f<a.x-a.csize||f>a.x+a.w+a.csize||k<a.y-a.csize||k>a.y+a.h+a.csize)&&g()});l.click(function(c){var d=$(l).offset();
f=Math.floor(c.pageX-d.left);k=Math.floor(c.pageY-d.top);f>a.x-2*a.csize&&(f<a.x+2*a.csize&&k>a.y+m-2*a.csize&&k<a.y+m+2*a.csize)&&(l.unbind(),j.unbind(),l.remove(),l[0]=null,t.remove(),t[0]=null,j.next().remove(),j.next()[0]=null,j.remove(),j[0]=null,b.children(".draggable").each(function(){$(this)[0]=null;$(this).remove()}),b.removeData("zdx"),b.removeData("zdy"),b.removeData("zw"),b.removeData("zh"),b.css("cursor","default"),"canvas_appended"==b.next().attr("class")&&"canvas"==b.next()[0].tagName.toLowerCase()&&
(b.next()[0]=null,b.next().remove()),b.removeClass("removed"),b.css("z-index","998"));f>a.x+n-2*a.csize&&(f<a.x+n+2*a.csize&&k>a.y+m-2*a.csize&&k<a.y+m+2*a.csize)&&g()})}
function autoCentered(b,c){function s(a,b,c,d){this.x=a;this.y=b;this.w=c;this.h=d;this.px=a;this.py=b;this.csize=15;this.bHow=[!1,!1,!1,!1];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[!1,!1,!1,!1];this.bDragAll=!1;this.oImg=null}var d,g,a,l=Math.round(parseInt(b.css("left"),10)),p=Math.round(parseInt(b.css("top"),10)),f=Math.round(parseInt(b.css("width"),10)),k=Math.round(parseInt(b.css("height"),10)),r,u,h=Math.round(parseInt(b.css("border-left-width"),10)),q,j;s.prototype.draw=
function(){d.w>=d.h?(q=d.w+h,j=Math.round(c.height*(d.w/c.width))+h,j<d.h&&(j=d.h+h,q=Math.round(c.width*(j/c.height))+h)):d.w<d.h&&(q=Math.round(c.width*(d.h/c.height))+h,j=d.h+h,q<d.w&&(q=d.w+h,j=Math.round(c.height*(q/c.width))+h));isImageUnclear(c.width,c.height,q,j,b);a.drawImage(c,0,0,c.width,c.height,d.x+h,d.y+h,q,j);d.oImg=a.getImageData(l+h,p+h,f+h,k+h);a.fillStyle="rgba(0, 0, 0, 0.5)";a.fillRect(d.x+h,d.y+h,q,j);a.strokeStyle="#fff";a.lineWidth=h;a.strokeRect(d.x-d.iCSize[0],d.y-d.iCSize[0],
q+2*h+2*d.iCSize[0],j+2*h+2*d.iCSize[0]);var e=$("<canvas>"),g=$("<canvas>");g.attr("id","clipper.temp");g[0].setAttribute("style","position: absolute; z-index:1002;");g[0].style.top=p+h+"px";g[0].style.left=l+h+"px";g[0].width=f+h;g[0].height=k+h;e[0].width=f+h;e[0].height=k+h;var m=e[0].getContext("2d"),n=g[0].getContext("2d");m.putImageData(d.oImg,0,0);0<=r.attr("class").indexOf("layout_circle")?cirClipper(n,e[0],f):0<=r.attr("class").indexOf("layout_square")&&boxClipper(n,e[0],f,k);"undefined"!=
typeof r.next()[0]&&"canvas"==r.next()[0].tagName.toLowerCase()&&(r.next()[0]=null,r.next().remove());r.after(g)};"true"==b.children(".draggable").data("is_unclear")?(console.log("\u6b64\u5716\u5df2\u5931\u771f"),IS_UNCLEAR=!0):IS_UNCLEAR=!1;$("body").append('<div class="modalOverlay"></div>');u=$(".modalOverlay");g=$("<canvas>");g[0].width=Math.round(parseInt($("body").css("width"),10));g[0].height=Math.round(parseInt($(document).height(),10));g.css("position","absolute");g.css("left","0px");g.css("top",
"0px");g.css("z-index","1001");$("body").append(g);r=b.clone();r.css("z-index","1003");r.css("opacity",1);$("body").append(r);a=g[0].getContext("2d");if("undefined"!=typeof b.children(".draggable").data("zdx"))d=new s(Math.round(parseInt(b.css("left"),10))-b.children(".draggable").data("zdx"),Math.round(parseInt(b.css("top"),10))-b.children(".draggable").data("zdy"),b.children(".draggable").data("zw")-h,b.children(".draggable").data("zh")-h);else{var t,e,n,m;f>=k?(t=f,e=Math.round(c.height*(f/c.width)),
e<k&&(e=k,t=Math.round(c.width*(k/c.height)))):f<k&&(t=Math.round(c.width*(k/c.height)),e=k,t<f&&(t=f,e=Math.round(c.height*(t/c.width))));t>e?(n=l-Math.round((t-f)/2),m=p):e>t?(n=l,m=p-Math.round((e-k)/2)):f>k?(n=l,m=p-Math.round((e-k)/2)):(n=f<k?l-Math.round((t-f)/2):l,m=p);d=new s(n,m,t,e)}a.clearRect(-d.csize/2,-d.csize/2,a.canvas.width+d.csize,a.canvas.height+d.csize);d.draw();"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove());0<=b.attr("class").indexOf("layout_circle")?
(t=$("<canvas>"),t[0].width=f+h,t[0].height=k+h,e=t[0].getContext("2d"),e.putImageData(d.oImg,0,0),doClipping(doMasking(t[0],maskImg,b,layout_ox,layout_oy),b,cirClipper)):0<=b.attr("class").indexOf("layout_square")&&(t=$("<canvas>"),t[0].width=f+h,t[0].height=k+h,e=t[0].getContext("2d"),e.putImageData(d.oImg,0,0),doClipping(doMasking(t[0],maskImg,b,layout_ox,layout_oy),b,boxClipper));b.next().mouseenter(function(){$(".layout_corner").css("z-index","996");$(this).prev().css("z-index","998")});b.children(".draggable").data("zdx",
l-d.x);b.children(".draggable").data("zdy",p-d.y);b.children(".draggable").data("zw",q);b.children(".draggable").data("zh",j);g.unbind();r.unbind();g.remove();g[0]=null;u.remove();u[0]=null;r.next().remove();r.next()[0]=null;r.remove();r[0]=null;$("body").css("cursor","default")};