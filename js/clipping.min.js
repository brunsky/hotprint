var IS_UNCLEAR=!1,COUNTER_UNCLEAR=0;
function isImageUnclear(b,c,q,e,f){if(!1==IS_UNCLEAR){if(q>b||e>c)IS_UNCLEAR=!0,COUNTER_UNCLEAR++,$warning=$("<div></div>"),$warning.addClass("warning"+f.attr("id")),$warning.addClass("warning"),$warning.css("position","absolute"),$warning.css("top",f.css("top")),$warning.css("left",f.css("left")),$warning.css("z-index","998"),$warning.html('<img src="../css/images/warning.png" />'),$warning.children("img")[0].width=32,$warning.children("img")[0].height=32,$("body").append($warning),0>=$(".warning_big").length&&
($warning_big=$("<div></div>"),$warning.addClass("warning_big"))}else!0==IS_UNCLEAR&&(q<=b&&e<=c)&&(IS_UNCLEAR=!1,removeUnclearWarning(f.attr("id")))}function removeUnclearWarning(b){$(".warning"+b).remove();COUNTER_UNCLEAR--}
function autoClipper(b,c){var q=$("<canvas>"),e=q[0].getContext("2d");IS_UNCLEAR=!1;q[0].width=$(b).data("zw");q[0].height=$(b).data("zh");e.drawImage(b,0,0,$(b).data("zw"),$(b).data("zh"));c[0].getContext("2d").putImageData(e.getImageData($(b).data("zdx"),$(b).data("zdy"),c[0].width,c[0].height),0,0)}function max(b,c){return b>=c?b:c}
function autoClipper2(b,c,q,e){var f=Math.round(parseInt(e.css("border-left-width"),10)),u=Math.round(parseInt(e.css("width"),10))+f,w=Math.round(parseInt(e.css("height"),10))+f,v=Math.round(parseInt(q.css("width"),10))+f;q=Math.round(parseInt(q.css("height"),10))+f;var a=max(u,w)/max(v,q),v=Math.round($(b).data("zw")*a);q=Math.round($(b).data("zh")*a);v<c[0].width&&(v=Math.round(c[0].width)+f,q=Math.round($(b).data("zh")*(v/$(b).data("zw")))+f);q<c[0].height&&(q=Math.round(c[0].height)+f,v=Math.round($(b).data("zw")*
(q/$(b).data("zh")))+f);"true"==$(b).data("is_unclear")?(console.log("\u6b64\u5716\u5df2\u5931\u771f"),IS_UNCLEAR=!0):IS_UNCLEAR=!1;f=new Image;f.src=e.children(".draggable").attr("src");isImageUnclear(f.width,f.height,v,q,e);$(b).data("zw",v);$(b).data("zh",q);e=Math.round($(b).data("zdx")*a);f=Math.round($(b).data("zdy")*a);q-f<w&&(f=0);v-e<u&&(e=0);$(b).data("zdx",e);$(b).data("zdy",f);u=$("<canvas>");w=u[0].getContext("2d");u[0].width=$(b).data("zw");u[0].height=$(b).data("zh");w.drawImage(b,
0,0,$(b).data("zw"),$(b).data("zh"));c[0].getContext("2d").putImageData(w.getImageData($(b).data("zdx"),$(b).data("zdy"),c[0].width,c[0].height),0,0)}var bMove=new Image;bMove.src="css/images/move.png";var bZoom=new Image;bZoom.src="css/images/zoom.png";var bSave=new Image;bSave.src="css/images/ok.png";var bRemove=new Image;bRemove.src="css/images/del.png";
function realClipper(b,c){function q(a,b,c,d){this.x=a;this.y=b;this.w=c;this.h=d;this.px=a;this.py=b;this.csize=15;this.bHow=[!1,!1,!1,!1];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[!1,!1,!1,!1];this.bDragAll=!1;this.oImg=null}function e(){h.clearRect(-a.csize/2,-a.csize/2,h.canvas.width+a.csize,h.canvas.height+a.csize);a.draw()}function f(){"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove());if(0<=b.attr("class").indexOf("layout_circle")){var c=
$("<canvas>");c[0].width=g+k;c[0].height=l+k;var d=c[0].getContext("2d");d.putImageData(a.oImg,0,0);doClipping(doMasking(c[0],maskImg,b,layout_ox,layout_oy),b,cirClipper)}else 0<=b.attr("class").indexOf("layout_square")&&(c=$("<canvas>"),c[0].width=g+k,c[0].height=l+k,d=c[0].getContext("2d"),d.putImageData(a.oImg,0,0),doClipping(doMasking(c[0],maskImg,b,layout_ox,layout_oy),b,boxClipper));b.next().mouseenter(function(){$(".layout_corner").css("z-index","996");$(this).prev().css("z-index","998")});
b.children(".draggable").data("zdx",r-a.x);b.children(".draggable").data("zdy",s-a.y);b.children(".draggable").data("zw",t);b.children(".draggable").data("zh",p);j.unbind();n.unbind();j.remove();j[0]=null;x.remove();x[0]=null;n.next().remove();n.next()[0]=null;n.remove();n[0]=null;$("body").css("cursor","default")}function u(b){var c=$(j).offset();m=Math.floor(b.pageX-c.left);d=Math.floor(b.pageY-c.top);if(a.bDragAll||a.bDrag[0])$("body").css("cursor","move"),a.x=m-a.px,a.x>=r&&(a.x=r),a.x+t<=r+g+
k+k&&(a.x=r+g+k-t),a.y=d-a.py,a.y>=s&&(a.y=s),a.y+p<=s+l+k+k&&(a.y=s+l+k-p);for(i=0;4>i;i++)a.bHow[i]=!1,a.iCSize[i]=a.csize;m>a.x-2*a.csize&&m<a.x&&d>a.y-2*a.csize&&d<a.y?($("body").css("cursor","move"),a.bHow[0]=!0):m>a.x+t&&m<a.x+t+2*a.csize&&d>a.y-2*a.csize&&d<a.y?($("body").css("cursor","sw-resize"),a.bHow[1]=!0):m>a.x+t&&m<a.x+t+2*a.csize&&d>a.y+p&&d<a.y+p+2*a.csize?($("body").css("cursor","pointer"),a.bHow[2]=!0):m>a.x-2*a.csize&&m<a.x&&d>a.y+p&&d<a.y+p+2*a.csize?($("body").css("cursor","pointer"),
a.bHow[3]=!0):$("body").css("cursor","default");if(a.bDrag[1]){$("body").css("cursor","sw-resize");c=a.x+t/2;b=a.y+p/2;var f=m-c,h=d-b;0>f&&(f=-f);0>h&&(h=-h);h=(f+h)/(t+p);h/=C;f=Math.round(t*h);h=Math.round(p*h);c=Math.round(c-f/2);b=Math.round(b-h/2);a.w=f<g?g:f;a.h=h<l?l:h;a.x=c>r?r:c+f<r+g?r+g-f:c;a.y=b>s?s:b+h<s+l?s+l-h:b}e()}function w(b){var c=$(j).offset();m=Math.floor(b.pageX-c.left);d=Math.floor(b.pageY-c.top);a.px=m-a.x;a.py=d-a.y;a.bHow[0]&&(a.px=m-a.x,a.py=d-a.y);a.bHow[1]&&(a.px=m-
a.x-a.w,a.py=d-a.y,b=m-(a.x+t/2),c=d-(a.y+p/2),0>b&&(b=-b),0>c&&(c=-c),C=(b+c)/(t+p));a.bHow[2]&&(a.px=m-a.x-a.w,a.py=d-a.y-a.h);a.bHow[3]&&(a.px=m-a.x,a.py=d-a.y-a.h);m>a.x&&(m<a.x+a.w&&d>a.y&&d<a.y+a.h)&&(a.bDragAll=!0);for(i=0;4>i;i++)a.bHow[i]&&(a.bDrag[i]=!0)}function v(){a.bDragAll=!1;$("body").css("cursor","default");for(i=0;4>i;i++)a.bDrag[i]=!1;a.px=0;a.py=0}var a,j,h,m,d=1,r=Math.round(parseInt(b.css("left"),10)),s=Math.round(parseInt(b.css("top"),10)),g=Math.round(parseInt(b.css("width"),
10)),l=Math.round(parseInt(b.css("height"),10)),n,x,k=Math.round(parseInt(b.css("border-left-width"),10)),t,p,C;q.prototype.draw=function(){a.w>=a.h?(t=a.w+k,p=Math.round(c.height*(a.w/c.width))+k,p<a.h&&(p=a.h+k,t=Math.round(c.width*(p/c.height))+k)):a.w<a.h&&(t=Math.round(c.width*(a.h/c.height))+k,p=a.h+k,t<a.w&&(t=a.w+k,p=Math.round(c.height*(t/c.width))+k));isImageUnclear(c.width,c.height,t,p,b);h.drawImage(c,0,0,c.width,c.height,a.x+k,a.y+k,t,p);a.oImg=h.getImageData(r+k,s+k,g+k,l+k);h.fillStyle=
"rgba(0, 0, 0, 0.5)";h.fillRect(a.x+k,a.y+k,t,p);h.strokeStyle="#fff";h.lineWidth=k;h.strokeRect(a.x-a.iCSize[0],a.y-a.iCSize[0],t+2*k+2*a.iCSize[0],p+2*k+2*a.iCSize[0]);var d=$("<canvas>"),e=$("<canvas>");e.attr("id","clipper.temp");e[0].setAttribute("style","position: absolute; z-index:1002;");e[0].style.top=s+k+"px";e[0].style.left=r+k+"px";e[0].width=g+k;e[0].height=l+k;d[0].width=g+k;d[0].height=l+k;var f=d[0].getContext("2d"),j=e[0].getContext("2d");f.putImageData(a.oImg,0,0);0<=n.attr("class").indexOf("layout_circle")?
cirClipper(j,d[0],g):0<=n.attr("class").indexOf("layout_square")&&boxClipper(j,d[0],g,l);"undefined"!=typeof n.next()[0]&&"canvas"==n.next()[0].tagName.toLowerCase()&&(n.next()[0]=null,n.next().remove());n.after(e);h.fillStyle="#fff";h.drawImage(bMove,a.x-2*a.iCSize[0],a.y-2*a.iCSize[0],2*a.iCSize[0],2*a.iCSize[0]);h.drawImage(bZoom,a.x+t+2*k,a.y-2*a.iCSize[1],2*a.iCSize[1],2*a.iCSize[1]);h.drawImage(bSave,a.x+t+2*k,a.y+p+2*k,2*a.iCSize[2],2*a.iCSize[2]);h.drawImage(bRemove,a.x-2*a.iCSize[3],a.y+
p+2*k,2*a.iCSize[3],2*a.iCSize[3])};"true"==b.children(".draggable").data("is_unclear")?(console.log("\u6b64\u5716\u5df2\u5931\u771f"),IS_UNCLEAR=!0):IS_UNCLEAR=!1;$("body").append('<div class="modalOverlay"></div>');x=$(".modalOverlay");j=$("<canvas>");j[0].width=Math.round(parseInt($("body").css("width"),10));j[0].height=Math.round(parseInt($(document).height(),10));j.css("position","absolute");j.css("left","0px");j.css("top","0px");j.css("z-index","1001");$("body").append(j);n=b.clone();n.css("z-index",
"1003");n.css("opacity",1);$("body").append(n);n.mousemove(u);n.mousedown(w);n.mouseup(v);h=j[0].getContext("2d");if("undefined"!=typeof b.children(".draggable").data("zdx"))a=new q(Math.round(parseInt(b.css("left"),10))-b.children(".draggable").data("zdx"),Math.round(parseInt(b.css("top"),10))-b.children(".draggable").data("zdy"),b.children(".draggable").data("zw")-k,b.children(".draggable").data("zh")-k);else{var y,z,A,B;g>=l?(y=g,z=Math.round(c.height*(g/c.width)),z<l&&(z=l,y=Math.round(c.width*
(l/c.height)))):g<l&&(y=Math.round(c.width*(l/c.height)),z=l,y<g&&(y=g,z=Math.round(c.height*(y/c.width))));y>z?(A=r-Math.round((y-g)/2),B=s):z>y?(A=r,B=s-Math.round((z-l)/2)):(A=r,B=s);a=new q(A,B,y,z)}e();j.mousemove(u);j.mousedown(w);j.mouseup(v);j.dblclick(function(b){var c=$(j).offset();m=Math.floor(b.pageX-c.left);d=Math.floor(b.pageY-c.top);(m<a.x-a.csize||m>a.x+a.w+a.csize||d<a.y-a.csize||d>a.y+a.h+a.csize)&&f()});j.click(function(c){var e=$(j).offset();m=Math.floor(c.pageX-e.left);d=Math.floor(c.pageY-
e.top);m>a.x-2*a.csize&&(m<a.x+2*a.csize&&d>a.y+p-2*a.csize&&d<a.y+p+2*a.csize)&&(j.unbind(),n.unbind(),j.remove(),j[0]=null,x.remove(),x[0]=null,n.next().remove(),n.next()[0]=null,n.remove(),n[0]=null,b.children(".draggable").each(function(){$(this)[0]=null;$(this).remove()}),b.removeData("zdx"),b.removeData("zdy"),b.removeData("zw"),b.removeData("zh"),b.css("cursor","default"),"canvas_appended"==b.next().attr("class")&&"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove()),
b.removeClass("removed"),b.css("z-index","998"));m>a.x+t-2*a.csize&&(m<a.x+t+2*a.csize&&d>a.y+p-2*a.csize&&d<a.y+p+2*a.csize)&&f()})}
function autoCentered(b,c){function q(a,b,c,d){this.x=a;this.y=b;this.w=c;this.h=d;this.px=a;this.py=b;this.csize=15;this.bHow=[!1,!1,!1,!1];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[!1,!1,!1,!1];this.bDragAll=!1;this.oImg=null}var e,f,u,w=Math.round(parseInt(b.css("left"),10)),v=Math.round(parseInt(b.css("top"),10)),a=Math.round(parseInt(b.css("width"),10)),j=Math.round(parseInt(b.css("height"),10)),h,m,d=Math.round(parseInt(b.css("border-left-width"),10)),r,s;q.prototype.draw=
function(){e.w>=e.h?(r=e.w+d,s=Math.round(c.height*(e.w/c.width))+d,s<e.h&&(s=e.h+d,r=Math.round(c.width*(s/c.height))+d)):e.w<e.h&&(r=Math.round(c.width*(e.h/c.height))+d,s=e.h+d,r<e.w&&(r=e.w+d,s=Math.round(c.height*(r/c.width))+d));isImageUnclear(c.width,c.height,r,s,b);u.drawImage(c,0,0,c.width,c.height,e.x+d,e.y+d,r,s);e.oImg=u.getImageData(w+d,v+d,a+d,j+d);u.fillStyle="rgba(0, 0, 0, 0.5)";u.fillRect(e.x+d,e.y+d,r,s);u.strokeStyle="#fff";u.lineWidth=d;u.strokeRect(e.x-e.iCSize[0],e.y-e.iCSize[0],
r+2*d+2*e.iCSize[0],s+2*d+2*e.iCSize[0]);var f=$("<canvas>"),g=$("<canvas>");g.attr("id","clipper.temp");g[0].setAttribute("style","position: absolute; z-index:1002;");g[0].style.top=v+d+"px";g[0].style.left=w+d+"px";g[0].width=a+d;g[0].height=j+d;f[0].width=a+d;f[0].height=j+d;var l=f[0].getContext("2d"),m=g[0].getContext("2d");l.putImageData(e.oImg,0,0);0<=h.attr("class").indexOf("layout_circle")?cirClipper(m,f[0],a):0<=h.attr("class").indexOf("layout_square")&&boxClipper(m,f[0],a,j);"undefined"!=
typeof h.next()[0]&&"canvas"==h.next()[0].tagName.toLowerCase()&&(h.next()[0]=null,h.next().remove());h.after(g)};"true"==b.children(".draggable").data("is_unclear")?(console.log("\u6b64\u5716\u5df2\u5931\u771f"),IS_UNCLEAR=!0):IS_UNCLEAR=!1;$("body").append('<div class="modalOverlay"></div>');m=$(".modalOverlay");f=$("<canvas>");f[0].width=Math.round(parseInt($("body").css("width"),10));f[0].height=Math.round(parseInt($(document).height(),10));f.css("position","absolute");f.css("left","0px");f.css("top",
"0px");f.css("z-index","1001");$("body").append(f);h=b.clone();h.css("z-index","1003");h.css("opacity",1);$("body").append(h);u=f[0].getContext("2d");if("undefined"!=typeof b.children(".draggable").data("zdx"))e=new q(Math.round(parseInt(b.css("left"),10))-b.children(".draggable").data("zdx"),Math.round(parseInt(b.css("top"),10))-b.children(".draggable").data("zdy"),b.children(".draggable").data("zw")-d,b.children(".draggable").data("zh")-d);else{var g,l,n,x;a>=j?(g=a,l=Math.round(c.height*(a/c.width)),
l<j&&(l=j,g=Math.round(c.width*(j/c.height)))):a<j&&(g=Math.round(c.width*(j/c.height)),l=j,g<a&&(g=a,l=Math.round(c.height*(g/c.width))));g>l?(n=w-Math.round((g-a)/2),x=v):l>g?(n=w,x=v-Math.round((l-j)/2)):a>j?(n=w,x=v-Math.round((l-j)/2)):(n=a<j?w-Math.round((g-a)/2):w,x=v);e=new q(n,x,g,l)}u.clearRect(-e.csize/2,-e.csize/2,u.canvas.width+e.csize,u.canvas.height+e.csize);e.draw();"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove());0<=b.attr("class").indexOf("layout_circle")?
(g=$("<canvas>"),g[0].width=a+d,g[0].height=j+d,l=g[0].getContext("2d"),l.putImageData(e.oImg,0,0),doClipping(doMasking(g[0],maskImg,b,layout_ox,layout_oy),b,cirClipper)):0<=b.attr("class").indexOf("layout_square")&&(g=$("<canvas>"),g[0].width=a+d,g[0].height=j+d,l=g[0].getContext("2d"),l.putImageData(e.oImg,0,0),doClipping(doMasking(g[0],maskImg,b,layout_ox,layout_oy),b,boxClipper));b.next().mouseenter(function(){$(".layout_corner").css("z-index","996");$(this).prev().css("z-index","998")});b.children(".draggable").data("zdx",
w-e.x);b.children(".draggable").data("zdy",v-e.y);b.children(".draggable").data("zw",r);b.children(".draggable").data("zh",s);f.unbind();h.unbind();f.remove();f[0]=null;m.remove();m[0]=null;h.next().remove();h.next()[0]=null;h.remove();h[0]=null;$("body").css("cursor","default")};