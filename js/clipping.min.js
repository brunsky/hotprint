function autoClipper(b,d){var e=$("<canvas>"),q=e[0].getContext("2d");e[0].width=$(b).data("zw");e[0].height=$(b).data("zh");q.drawImage(b,0,0,$(b).data("zw"),$(b).data("zh"));d[0].getContext("2d").putImageData(q.getImageData($(b).data("zdx"),$(b).data("zdy"),d[0].width,d[0].height),0,0)}function max(b,d){return b>=d?b:d}
function autoClipper2(b,d,e,q){var r=Math.round(parseInt(q.css("border-left-width"),10)),x=Math.round(parseInt(q.css("width"),10))+r;q=Math.round(parseInt(q.css("height"),10))+r;var u=Math.round(parseInt(e.css("width"),10))+r;e=Math.round(parseInt(e.css("height"),10))+r;var v=max(x,q)/max(u,e);e=Math.round($(b).data("zw")*v);u=Math.round($(b).data("zh")*v);e<d[0].width&&(e=Math.round(d[0].width)+r,u=Math.round($(b).data("zh")*(e/$(b).data("zw")))+r);u<d[0].height&&(u=Math.round(d[0].height)+r,e=Math.round($(b).data("zw")*
(u/$(b).data("zh")))+r);$(b).data("zw",e);$(b).data("zh",u);r=Math.round($(b).data("zdx")*v);v=Math.round($(b).data("zdy")*v);u-v<q&&(v=0);e-r<x&&(r=0);$(b).data("zdx",r);$(b).data("zdy",v);x=$("<canvas>");q=x[0].getContext("2d");x[0].width=$(b).data("zw");x[0].height=$(b).data("zh");q.drawImage(b,0,0,$(b).data("zw"),$(b).data("zh"));d[0].getContext("2d").putImageData(q.getImageData($(b).data("zdx"),$(b).data("zdy"),d[0].width,d[0].height),0,0)}var bMove=new Image;bMove.src="css/images/move.png";
var bZoom=new Image;bZoom.src="css/images/zoom.png";var bSave=new Image;bSave.src="css/images/ok.png";var bRemove=new Image;bRemove.src="css/images/del.png";
function realClipper(b,d){function e(a,b,c,d){this.x=a;this.y=b;this.w=c;this.h=d;this.px=a;this.py=b;this.csize=15;this.bHow=[!1,!1,!1,!1];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[!1,!1,!1,!1];this.bDragAll=!1;this.oImg=null}function q(){p.clearRect(-a.csize/2,-a.csize/2,p.canvas.width+a.csize,p.canvas.height+a.csize);a.draw()}function r(){"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove());if(0<=b.attr("class").indexOf("layout_circle")){var y=
$("<canvas>");y[0].width=m+c;y[0].height=n+c;var d=y[0].getContext("2d");d.putImageData(a.oImg,0,0);doClipping(doMasking(y[0],maskImg,b,layout_ox,layout_oy),b,cirClipper)}else 0<=b.attr("class").indexOf("layout_square")&&(y=$("<canvas>"),y[0].width=m+c,y[0].height=n+c,d=y[0].getContext("2d"),d.putImageData(a.oImg,0,0),doClipping(doMasking(y[0],maskImg,b,layout_ox,layout_oy),b,boxClipper));b.next().mouseenter(function(){$(".layout_corner").css("z-index","996");$(this).prev().css("z-index","998")});
b.children(".draggable").data("zdx",s-a.x);b.children(".draggable").data("zdy",t-a.y);b.children(".draggable").data("zw",k);b.children(".draggable").data("zh",j);l.unbind();f.unbind();l.remove();l[0]=null;A.remove();A[0]=null;f.next().remove();f.next()[0]=null;f.remove();f[0]=null;$("body").css("cursor","default")}function x(b){var d=$(l).offset();h=Math.floor(b.pageX-d.left);g=Math.floor(b.pageY-d.top);if(a.bDragAll||a.bDrag[0])$("body").css("cursor","move"),a.x=h-a.px,a.x>=s&&(a.x=s),a.x+k<=s+m+
c+c&&(a.x=s+m+c-k),a.y=g-a.py,a.y>=t&&(a.y=t),a.y+j<=t+n+c+c&&(a.y=t+n+c-j);for(i=0;4>i;i++)a.bHow[i]=!1,a.iCSize[i]=a.csize;h>a.x-2*a.csize&&h<a.x&&g>a.y-2*a.csize&&g<a.y?($("body").css("cursor","move"),a.bHow[0]=!0):h>a.x+k&&h<a.x+k+2*a.csize&&g>a.y-2*a.csize&&g<a.y?($("body").css("cursor","sw-resize"),a.bHow[1]=!0):h>a.x+k&&h<a.x+k+2*a.csize&&g>a.y+j&&g<a.y+j+2*a.csize?($("body").css("cursor","pointer"),a.bHow[2]=!0):h>a.x-2*a.csize&&h<a.x&&g>a.y+j&&g<a.y+j+2*a.csize?($("body").css("cursor","pointer"),
a.bHow[3]=!0):$("body").css("cursor","default");if(a.bDrag[1]){$("body").css("cursor","sw-resize");d=a.x+k/2;b=a.y+j/2;var f=h-d,e=g-b;0>f&&(f=-f);0>e&&(e=-e);e=(f+e)/(k+j);e/=D;f=Math.round(k*e);e=Math.round(j*e);d=Math.round(d-f/2);b=Math.round(b-e/2);a.w=f<m?m:f;a.h=e<n?n:e;a.x=d>s?s:d+f<s+m?s+m-f:d;a.y=b>t?t:b+e<t+n?t+n-e:b}q()}function u(b){var c=$(l).offset();h=Math.floor(b.pageX-c.left);g=Math.floor(b.pageY-c.top);a.px=h-a.x;a.py=g-a.y;a.bHow[0]&&(a.px=h-a.x,a.py=g-a.y);a.bHow[1]&&(a.px=h-
a.x-a.w,a.py=g-a.y,b=h-(a.x+k/2),c=g-(a.y+j/2),0>b&&(b=-b),0>c&&(c=-c),D=(b+c)/(k+j));a.bHow[2]&&(a.px=h-a.x-a.w,a.py=g-a.y-a.h);a.bHow[3]&&(a.px=h-a.x,a.py=g-a.y-a.h);h>a.x&&(h<a.x+a.w&&g>a.y&&g<a.y+a.h)&&(a.bDragAll=!0);for(i=0;4>i;i++)a.bHow[i]&&(a.bDrag[i]=!0)}function v(){a.bDragAll=!1;$("body").css("cursor","default");for(i=0;4>i;i++)a.bDrag[i]=!1;a.px=0;a.py=0}var a,l,p,h,g=1,s=Math.round(parseInt(b.css("left"),10)),t=Math.round(parseInt(b.css("top"),10)),m=Math.round(parseInt(b.css("width"),
10)),n=Math.round(parseInt(b.css("height"),10)),f,A,c=Math.round(parseInt(b.css("border-left-width"),10)),k,j,D;e.prototype.draw=function(){a.w>=a.h?(k=a.w+c,j=Math.round(d.height*(a.w/d.width))+c,j<a.h&&(j=a.h+c,k=Math.round(d.width*(j/d.height))+c)):a.w<a.h&&(k=Math.round(d.width*(a.h/d.height))+c,j=a.h+c,k<a.w&&(k=a.w+c,j=Math.round(d.height*(k/d.width))+c));p.drawImage(d,0,0,d.width,d.height,a.x+c,a.y+c,k,j);a.oImg=p.getImageData(s+c,t+c,m+c,n+c);p.fillStyle="rgba(0, 0, 0, 0.5)";p.fillRect(a.x+
c,a.y+c,k,j);p.strokeStyle="#fff";p.lineWidth=c;p.strokeRect(a.x-a.iCSize[0],a.y-a.iCSize[0],k+2*c+2*a.iCSize[0],j+2*c+2*a.iCSize[0]);var b=$("<canvas>"),e=$("<canvas>");e.attr("id","clipper.temp");e[0].setAttribute("style","position: absolute; z-index:1002;");e[0].style.top=t+c+"px";e[0].style.left=s+c+"px";e[0].width=m+c;e[0].height=n+c;b[0].width=m+c;b[0].height=n+c;var h=b[0].getContext("2d"),g=e[0].getContext("2d");h.putImageData(a.oImg,0,0);0<=f.attr("class").indexOf("layout_circle")?cirClipper(g,
b[0],m):0<=f.attr("class").indexOf("layout_square")&&boxClipper(g,b[0],m,n);"undefined"!=typeof f.next()[0]&&"canvas"==f.next()[0].tagName.toLowerCase()&&(f.next()[0]=null,f.next().remove());f.after(e);p.fillStyle="#fff";p.drawImage(bMove,a.x-2*a.iCSize[0],a.y-2*a.iCSize[0],2*a.iCSize[0],2*a.iCSize[0]);p.drawImage(bZoom,a.x+k+2*c,a.y-2*a.iCSize[1],2*a.iCSize[1],2*a.iCSize[1]);p.drawImage(bSave,a.x+k+2*c,a.y+j+2*c,2*a.iCSize[2],2*a.iCSize[2]);p.drawImage(bRemove,a.x-2*a.iCSize[3],a.y+j+2*c,2*a.iCSize[3],
2*a.iCSize[3])};$("body").append('<div class="modalOverlay"></div>');A=$(".modalOverlay");l=$("<canvas>");l[0].width=Math.round(parseInt($("body").css("width"),10));l[0].height=Math.round(parseInt($(document).height(),10));l.css("position","absolute");l.css("left","0px");l.css("top","0px");l.css("z-index","1001");$("body").append(l);f=b.clone();f.css("z-index","1003");f.css("opacity",1);$("body").append(f);f.mousemove(x);f.mousedown(u);f.mouseup(v);p=l[0].getContext("2d");if("undefined"!=typeof b.children(".draggable").data("zdx"))a=
new e(Math.round(parseInt(b.css("left"),10))-b.children(".draggable").data("zdx"),Math.round(parseInt(b.css("top"),10))-b.children(".draggable").data("zdy"),b.children(".draggable").data("zw")-c,b.children(".draggable").data("zh")-c);else{var w,z,B,C;m>=n?(w=m+c,z=Math.round(d.height*(m/d.width))+c,z<n&&(z=n+c,w=Math.round(d.width*(n/d.height))+c)):m<n&&(w=Math.round(d.width*(n/d.height))+c,z=n+c,w<m&&(w=m+c,z=Math.round(d.height*(w/d.width))+c));w>z?(B=s-(w-m)/2,C=t):z>w&&(B=s,C=t-(z-n)/2);a=new e(B,
C,w,z)}q();l.mousemove(x);l.mousedown(u);l.mouseup(v);l.dblclick(function(b){var c=$(l).offset();h=Math.floor(b.pageX-c.left);g=Math.floor(b.pageY-c.top);(h<a.x-a.csize||h>a.x+a.w+a.csize||g<a.y-a.csize||g>a.y+a.h+a.csize)&&r()});l.click(function(c){var d=$(l).offset();h=Math.floor(c.pageX-d.left);g=Math.floor(c.pageY-d.top);h>a.x-2*a.csize&&(h<a.x+2*a.csize&&g>a.y+j-2*a.csize&&g<a.y+j+2*a.csize)&&(l.unbind(),f.unbind(),l.remove(),l[0]=null,A.remove(),A[0]=null,f.next().remove(),f.next()[0]=null,
f.remove(),f[0]=null,b.children(".draggable").each(function(){$(this)[0]=null;$(this).remove()}),b.removeData("zdx"),b.removeData("zdy"),b.removeData("zw"),b.removeData("zh"),b.css("cursor","default"),"canvas_appended"==b.next().attr("class")&&"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove()),b.removeClass("removed"),b.css("z-index","998"));h>a.x+k-2*a.csize&&(h<a.x+k+2*a.csize&&g>a.y+j-2*a.csize&&g<a.y+j+2*a.csize)&&r()})};