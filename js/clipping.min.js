function autoClipper(b,c){var t=$("<canvas>"),e=t[0].getContext("2d");t[0].width=$(b).data("zw");t[0].height=$(b).data("zh");e.drawImage(b,0,0,$(b).data("zw"),$(b).data("zh"));c[0].getContext("2d").putImageData(e.getImageData($(b).data("zdx"),$(b).data("zdy"),c[0].width,c[0].height),0,0)}function max(b,c){return b>=c?b:c}
function autoClipper2(b,c,t,e){var f=Math.round(parseInt(e.css("border-left-width"),10)),u=Math.round(parseInt(e.css("width"),10))+f;e=Math.round(parseInt(e.css("height"),10))+f;var v=Math.round(parseInt(t.css("width"),10))+f;t=Math.round(parseInt(t.css("height"),10))+f;var w=max(u,e)/max(v,t);t=Math.round($(b).data("zw")*w);v=Math.round($(b).data("zh")*w);t<c[0].width&&(t=Math.round(c[0].width)+f,v=Math.round($(b).data("zh")*(t/$(b).data("zw")))+f);v<c[0].height&&(v=Math.round(c[0].height)+f,t=Math.round($(b).data("zw")*
(v/$(b).data("zh")))+f);$(b).data("zw",t);$(b).data("zh",v);f=Math.round($(b).data("zdx")*w);w=Math.round($(b).data("zdy")*w);v-w<e&&(w=0);t-f<u&&(f=0);$(b).data("zdx",f);$(b).data("zdy",w);u=$("<canvas>");e=u[0].getContext("2d");u[0].width=$(b).data("zw");u[0].height=$(b).data("zh");e.drawImage(b,0,0,$(b).data("zw"),$(b).data("zh"));c[0].getContext("2d").putImageData(e.getImageData($(b).data("zdx"),$(b).data("zdy"),c[0].width,c[0].height),0,0)}var bMove=new Image;bMove.src="css/images/move.png";
var bZoom=new Image;bZoom.src="css/images/zoom.png";var bSave=new Image;bSave.src="css/images/ok.png";var bRemove=new Image;bRemove.src="css/images/del.png";
function realClipper(b,c){function t(a,b,d,c){this.x=a;this.y=b;this.w=d;this.h=c;this.px=a;this.py=b;this.csize=15;this.bHow=[!1,!1,!1,!1];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[!1,!1,!1,!1];this.bDragAll=!1;this.oImg=null}function e(){g.clearRect(-a.csize/2,-a.csize/2,g.canvas.width+a.csize,g.canvas.height+a.csize);a.draw()}function f(){"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove());if(0<=b.attr("class").indexOf("layout_circle")){var d=
$("<canvas>");d[0].width=h+j;d[0].height=l+j;var c=d[0].getContext("2d");c.putImageData(a.oImg,0,0);doClipping(doMasking(d[0],maskImg,b,layout_ox,layout_oy),b,cirClipper)}else 0<=b.attr("class").indexOf("layout_square")&&(d=$("<canvas>"),d[0].width=h+j,d[0].height=l+j,c=d[0].getContext("2d"),c.putImageData(a.oImg,0,0),doClipping(doMasking(d[0],maskImg,b,layout_ox,layout_oy),b,boxClipper));b.next().mouseenter(function(){$(".layout_corner").css("z-index","996");$(this).prev().css("z-index","998")});
b.children(".draggable").data("zdx",r-a.x);b.children(".draggable").data("zdy",s-a.y);b.children(".draggable").data("zw",q);b.children(".draggable").data("zh",p);k.unbind();n.unbind();k.remove();k[0]=null;y.remove();y[0]=null;n.next().remove();n.next()[0]=null;n.remove();n[0]=null;$("body").css("cursor","default")}function u(b){var c=$(k).offset();m=Math.floor(b.pageX-c.left);d=Math.floor(b.pageY-c.top);if(a.bDragAll||a.bDrag[0])$("body").css("cursor","move"),a.x=m-a.px,a.x>=r&&(a.x=r),a.x+q<=r+h+
j+j&&(a.x=r+h+j-q),a.y=d-a.py,a.y>=s&&(a.y=s),a.y+p<=s+l+j+j&&(a.y=s+l+j-p);for(i=0;4>i;i++)a.bHow[i]=!1,a.iCSize[i]=a.csize;m>a.x-2*a.csize&&m<a.x&&d>a.y-2*a.csize&&d<a.y?($("body").css("cursor","move"),a.bHow[0]=!0):m>a.x+q&&m<a.x+q+2*a.csize&&d>a.y-2*a.csize&&d<a.y?($("body").css("cursor","sw-resize"),a.bHow[1]=!0):m>a.x+q&&m<a.x+q+2*a.csize&&d>a.y+p&&d<a.y+p+2*a.csize?($("body").css("cursor","pointer"),a.bHow[2]=!0):m>a.x-2*a.csize&&m<a.x&&d>a.y+p&&d<a.y+p+2*a.csize?($("body").css("cursor","pointer"),
a.bHow[3]=!0):$("body").css("cursor","default");if(a.bDrag[1]){$("body").css("cursor","sw-resize");c=a.x+q/2;b=a.y+p/2;var g=m-c,f=d-b;0>g&&(g=-g);0>f&&(f=-f);f=(g+f)/(q+p);f/=C;g=Math.round(q*f);f=Math.round(p*f);c=Math.round(c-g/2);b=Math.round(b-f/2);a.w=g<h?h:g;a.h=f<l?l:f;a.x=c>r?r:c+g<r+h?r+h-g:c;a.y=b>s?s:b+f<s+l?s+l-f:b}e()}function v(b){var c=$(k).offset();m=Math.floor(b.pageX-c.left);d=Math.floor(b.pageY-c.top);a.px=m-a.x;a.py=d-a.y;a.bHow[0]&&(a.px=m-a.x,a.py=d-a.y);a.bHow[1]&&(a.px=m-
a.x-a.w,a.py=d-a.y,b=m-(a.x+q/2),c=d-(a.y+p/2),0>b&&(b=-b),0>c&&(c=-c),C=(b+c)/(q+p));a.bHow[2]&&(a.px=m-a.x-a.w,a.py=d-a.y-a.h);a.bHow[3]&&(a.px=m-a.x,a.py=d-a.y-a.h);m>a.x&&(m<a.x+a.w&&d>a.y&&d<a.y+a.h)&&(a.bDragAll=!0);for(i=0;4>i;i++)a.bHow[i]&&(a.bDrag[i]=!0)}function w(){a.bDragAll=!1;$("body").css("cursor","default");for(i=0;4>i;i++)a.bDrag[i]=!1;a.px=0;a.py=0}var a,k,g,m,d=1,r=Math.round(parseInt(b.css("left"),10)),s=Math.round(parseInt(b.css("top"),10)),h=Math.round(parseInt(b.css("width"),
10)),l=Math.round(parseInt(b.css("height"),10)),n,y,j=Math.round(parseInt(b.css("border-left-width"),10)),q,p,C;t.prototype.draw=function(){a.w>=a.h?(q=a.w+j,p=Math.round(c.height*(a.w/c.width))+j,p<a.h&&(p=a.h+j,q=Math.round(c.width*(p/c.height))+j)):a.w<a.h&&(q=Math.round(c.width*(a.h/c.height))+j,p=a.h+j,q<a.w&&(q=a.w+j,p=Math.round(c.height*(q/c.width))+j));g.drawImage(c,0,0,c.width,c.height,a.x+j,a.y+j,q,p);a.oImg=g.getImageData(r+j,s+j,h+j,l+j);g.fillStyle="rgba(0, 0, 0, 0.5)";g.fillRect(a.x+
j,a.y+j,q,p);g.strokeStyle="#fff";g.lineWidth=j;g.strokeRect(a.x-a.iCSize[0],a.y-a.iCSize[0],q+2*j+2*a.iCSize[0],p+2*j+2*a.iCSize[0]);var b=$("<canvas>"),d=$("<canvas>");d.attr("id","clipper.temp");d[0].setAttribute("style","position: absolute; z-index:1002;");d[0].style.top=s+j+"px";d[0].style.left=r+j+"px";d[0].width=h+j;d[0].height=l+j;b[0].width=h+j;b[0].height=l+j;var e=b[0].getContext("2d"),f=d[0].getContext("2d");e.putImageData(a.oImg,0,0);0<=n.attr("class").indexOf("layout_circle")?cirClipper(f,
b[0],h):0<=n.attr("class").indexOf("layout_square")&&boxClipper(f,b[0],h,l);"undefined"!=typeof n.next()[0]&&"canvas"==n.next()[0].tagName.toLowerCase()&&(n.next()[0]=null,n.next().remove());n.after(d);g.fillStyle="#fff";g.drawImage(bMove,a.x-2*a.iCSize[0],a.y-2*a.iCSize[0],2*a.iCSize[0],2*a.iCSize[0]);g.drawImage(bZoom,a.x+q+2*j,a.y-2*a.iCSize[1],2*a.iCSize[1],2*a.iCSize[1]);g.drawImage(bSave,a.x+q+2*j,a.y+p+2*j,2*a.iCSize[2],2*a.iCSize[2]);g.drawImage(bRemove,a.x-2*a.iCSize[3],a.y+p+2*j,2*a.iCSize[3],
2*a.iCSize[3])};$("body").append('<div class="modalOverlay"></div>');y=$(".modalOverlay");k=$("<canvas>");k[0].width=Math.round(parseInt($("body").css("width"),10));k[0].height=Math.round(parseInt($(document).height(),10));k.css("position","absolute");k.css("left","0px");k.css("top","0px");k.css("z-index","1001");$("body").append(k);n=b.clone();n.css("z-index","1003");n.css("opacity",1);$("body").append(n);n.mousemove(u);n.mousedown(v);n.mouseup(w);g=k[0].getContext("2d");if("undefined"!=typeof b.children(".draggable").data("zdx"))a=
new t(Math.round(parseInt(b.css("left"),10))-b.children(".draggable").data("zdx"),Math.round(parseInt(b.css("top"),10))-b.children(".draggable").data("zdy"),b.children(".draggable").data("zw")-j,b.children(".draggable").data("zh")-j);else{var x,z,A,B;h>=l?(x=h,z=Math.round(c.height*(h/c.width)),z<l&&(z=l,x=Math.round(c.width*(l/c.height)))):h<l&&(x=Math.round(c.width*(l/c.height)),z=l,x<h&&(x=h,z=Math.round(c.height*(x/c.width))));x>z?(A=r-Math.round((x-h)/2),B=s):z>x&&(A=r,B=s-Math.round((z-l)/2));
a=new t(A,B,x,z)}e();k.mousemove(u);k.mousedown(v);k.mouseup(w);k.dblclick(function(b){var c=$(k).offset();m=Math.floor(b.pageX-c.left);d=Math.floor(b.pageY-c.top);(m<a.x-a.csize||m>a.x+a.w+a.csize||d<a.y-a.csize||d>a.y+a.h+a.csize)&&f()});k.click(function(c){var e=$(k).offset();m=Math.floor(c.pageX-e.left);d=Math.floor(c.pageY-e.top);m>a.x-2*a.csize&&(m<a.x+2*a.csize&&d>a.y+p-2*a.csize&&d<a.y+p+2*a.csize)&&(k.unbind(),n.unbind(),k.remove(),k[0]=null,y.remove(),y[0]=null,n.next().remove(),n.next()[0]=
null,n.remove(),n[0]=null,b.children(".draggable").each(function(){$(this)[0]=null;$(this).remove()}),b.removeData("zdx"),b.removeData("zdy"),b.removeData("zw"),b.removeData("zh"),b.css("cursor","default"),"canvas_appended"==b.next().attr("class")&&"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove()),b.removeClass("removed"),b.css("z-index","998"));m>a.x+q-2*a.csize&&(m<a.x+q+2*a.csize&&d>a.y+p-2*a.csize&&d<a.y+p+2*a.csize)&&f()})}
function autoCentered(b,c){function t(a,b,c,d){this.x=a;this.y=b;this.w=c;this.h=d;this.px=a;this.py=b;this.csize=15;this.bHow=[!1,!1,!1,!1];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[!1,!1,!1,!1];this.bDragAll=!1;this.oImg=null}var e,f,u,v=Math.round(parseInt(b.css("left"),10)),w=Math.round(parseInt(b.css("top"),10)),a=Math.round(parseInt(b.css("width"),10)),k=Math.round(parseInt(b.css("height"),10)),g,m,d=Math.round(parseInt(b.css("border-left-width"),10)),r,s;t.prototype.draw=
function(){e.w>=e.h?(r=e.w+d,s=Math.round(c.height*(e.w/c.width))+d,s<e.h&&(s=e.h+d,r=Math.round(c.width*(s/c.height))+d)):e.w<e.h&&(r=Math.round(c.width*(e.h/c.height))+d,s=e.h+d,r<e.w&&(r=e.w+d,s=Math.round(c.height*(r/c.width))+d));u.drawImage(c,0,0,c.width,c.height,e.x+d,e.y+d,r,s);e.oImg=u.getImageData(v+d,w+d,a+d,k+d);u.fillStyle="rgba(0, 0, 0, 0.5)";u.fillRect(e.x+d,e.y+d,r,s);u.strokeStyle="#fff";u.lineWidth=d;u.strokeRect(e.x-e.iCSize[0],e.y-e.iCSize[0],r+2*d+2*e.iCSize[0],s+2*d+2*e.iCSize[0]);
var b=$("<canvas>"),f=$("<canvas>");f.attr("id","clipper.temp");f[0].setAttribute("style","position: absolute; z-index:1002;");f[0].style.top=w+d+"px";f[0].style.left=v+d+"px";f[0].width=a+d;f[0].height=k+d;b[0].width=a+d;b[0].height=k+d;var h=b[0].getContext("2d"),l=f[0].getContext("2d");h.putImageData(e.oImg,0,0);0<=g.attr("class").indexOf("layout_circle")?cirClipper(l,b[0],a):0<=g.attr("class").indexOf("layout_square")&&boxClipper(l,b[0],a,k);"undefined"!=typeof g.next()[0]&&"canvas"==g.next()[0].tagName.toLowerCase()&&
(g.next()[0]=null,g.next().remove());g.after(f)};$("body").append('<div class="modalOverlay"></div>');m=$(".modalOverlay");f=$("<canvas>");f[0].width=Math.round(parseInt($("body").css("width"),10));f[0].height=Math.round(parseInt($(document).height(),10));f.css("position","absolute");f.css("left","0px");f.css("top","0px");f.css("z-index","1001");$("body").append(f);g=b.clone();g.css("z-index","1003");g.css("opacity",1);$("body").append(g);u=f[0].getContext("2d");if("undefined"!=typeof b.children(".draggable").data("zdx"))e=
new t(Math.round(parseInt(b.css("left"),10))-b.children(".draggable").data("zdx"),Math.round(parseInt(b.css("top"),10))-b.children(".draggable").data("zdy"),b.children(".draggable").data("zw")-d,b.children(".draggable").data("zh")-d);else{var h,l,n,y;a>=k?(h=a,l=Math.round(c.height*(a/c.width)),l<k&&(l=k,h=Math.round(c.width*(k/c.height)))):a<k&&(h=Math.round(c.width*(k/c.height)),l=k,h<a&&(h=a,l=Math.round(c.height*(h/c.width))));h>l?(n=v-Math.round((h-a)/2),y=w):l>h&&(n=v,y=w-Math.round((l-k)/2));
e=new t(n,y,h,l)}u.clearRect(-e.csize/2,-e.csize/2,u.canvas.width+e.csize,u.canvas.height+e.csize);e.draw();"canvas"==b.next()[0].tagName.toLowerCase()&&(b.next()[0]=null,b.next().remove());0<=b.attr("class").indexOf("layout_circle")?(h=$("<canvas>"),h[0].width=a+d,h[0].height=k+d,l=h[0].getContext("2d"),l.putImageData(e.oImg,0,0),doClipping(doMasking(h[0],maskImg,b,layout_ox,layout_oy),b,cirClipper)):0<=b.attr("class").indexOf("layout_square")&&(h=$("<canvas>"),h[0].width=a+d,h[0].height=k+d,l=h[0].getContext("2d"),
l.putImageData(e.oImg,0,0),doClipping(doMasking(h[0],maskImg,b,layout_ox,layout_oy),b,boxClipper));b.next().mouseenter(function(){$(".layout_corner").css("z-index","996");$(this).prev().css("z-index","998")});b.children(".draggable").data("zdx",v-e.x);b.children(".draggable").data("zdy",w-e.y);b.children(".draggable").data("zw",r);b.children(".draggable").data("zh",s);f.unbind();g.unbind();f.remove();f[0]=null;m.remove();m[0]=null;g.next().remove();g.next()[0]=null;g.remove();g[0]=null;$("body").css("cursor",
"default")};