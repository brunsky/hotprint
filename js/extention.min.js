function mode_history(){}
function mod_checkout(){$order=$("<div></div>");$order.addClass("order");$order.css("position","absolute");$order.css("top",$(".mainmenu").height()+50+"px");$order.load("checkout/checkout.html?v="+(new Date).getTime(),function(){simpleCart.update();$(".order a.preview").hover(function(a){var b=$(this).parent().offset();$(".order").append("<div id='preview'><img src='checkout/card.png'/></div>");$("#preview").css("position","relative");$("#preview").css("top",a.pageY-b.top+"px").css("left",a.pageX-
b.left+"px").fadeIn("fast")},function(){$("#preview").remove()});$(".order a.preview").mousemove(function(a){var b=$(this).parent().offset();$("#preview").css("top",a.pageY-b.top+"px").css("left",a.pageX-b.left+"px")});$("#checkout_cancel").click(function(){openGallery()});$("#checkout_confirm").click(function(){"\u78ba\u8a8d\u8cc7\u6599"==$("#checkout_confirm").val()?$.post("checkout/coupon.php",{code:$("#coupon_no").val(),userid:$.cookie("user_id")},function(a){if("ok"==a.result){var b=parseFloat($(".simpleCart_total").html().replace("$",
""),10).toFixed(2);a=(parseFloat($(".simpleCart_quantity").html().replace("$",""),10).toFixed(2)*a.value).toFixed(2);$(".simpleCart_total").html("").fadeIn(300).append("$"+(b-a).toFixed(2).toString());$("#coupon_no").after('<font color="red">\u5df2\u6298\u6263 $'+a+"</font>")}else"used"==a.value?$("#coupon_no").after('<font color="red">\u5df2\u7d93\u88ab\u4f7f\u7528</font>'):"invalid"==a.value?$("#coupon_no").after('<font color="red">\u7121\u6548\u7684\u6298\u6263\u78bc</font>'):$("#coupon_no").after('<font color="red">\u7a0d\u5f8c\u518d\u8a66</font>');
$("#checkout_confirm").val("\u5237\u5361\u4ed8\u6b3e")},"json"):(simpleCart({checkout:{type:"SendForm",url:HOST_URL+"checkout/bill.php",success:"index.html?b=succeed",cancel:"index.html?b=cancel",extra_data:{storename:$(".open").html(),userid:$.cookie("user_id"),token:$.cookie("access_token"),type:$.cookie("source"),card_no:$("#card_no").val(),expiry_date:$("#expiry_date").val(),cvc_no:$("#cvc_no").val(),coupon_no:$("#coupon_no").val(),total:$(".simpleCart_total").html().replace("$",""),shipping_email:$("#shipping_email").val(),
shipping_name:$("#shipping_name").val(),shipping_addr:$("#shipping_address").val(),shipping_city:$("#shipping_city").val(),shipping_country:$("#countrySelect :selected").text()}}}),simpleCart.checkout())})});$("body").append($order)}
function mod_gallery(){$g=$("<div></div>");$("body").append($g);$g.attr("id","gallery");$("#gallery").before('<div class="shopping_cart">\u8cfc\u7269\u8eca<div> ----------- </div><div class="simpleCart_items"></div><div style="float:left">\u7e3d\u8a08\uff1a</div><div class="simpleCart_total"></div><div class="checkout">\u7d50\u5e33</div></div>');$(".shopping_cart").css("top","100px");$(".shopping_cart").css("left","100px");simpleCart.bind("update",function(){$(".item-decrement").css("padding-right",
"12px");$(".item-quantity").css("padding-right","12px");$(".headerRow > .item-total").css("padding-left","100px");$("#gallery").css("top",Math.round(parseInt($(".shopping_cart").css("top")))+$(".shopping_cart").height()+50+"px");"$0.00"==$(".simpleCart_total").html()?$(".checkout").hide():$(".checkout").show()});$(".checkout").click(function(){releasePage("Gallery");newPage("Checkout")});simpleCart.update();$g.css("left","100px");$.cookie("user_id")&&$.post("db/retrive_gallery.php",{userid:$.cookie("user_id")},
function(a){a=$.parseJSON(a);"1587166409"==$.cookie("user_id")||"100004857218710"==$.cookie("user_id")||"527379830"==$.cookie("user_id")||"54327628"==$.cookie("user_id")||"1709821659"==$.cookie("user_id")?$.each(a,function(a,c){$("#gallery").append('<div class="simpleCart_shelfItem"><div class="g_img_wrap"><img src="'+c.orig_img+'" alt="image" /></div><br /><h2 class="item_name">'+c.title_name+"</h2>"+c.phone_type+", "+c.phone_color+"<br />"+c.s_save+'<br /><span class="item_price">$'+c.price+'</span><br><a class="item_add" href="javascript:;"> \u52a0\u5165\u8cfc\u7269\u8eca </a></p><input type="button" value="\u7522\u751f\u539f\u5716" onClick="_send_factory(\''+
c.s_save+"')\"></div>")}):$.each(a,function(a,c){$("#gallery").append('<div class="simpleCart_shelfItem"><img src="'+c.orig_img+'" alt="image" /><br /><h2 class="item_name">'+c.phone_type+"</h2>"+c.phone_color+"<br />"+c.s_save+'<br /><span class="item_price">$'+c.price+'</span><br><a class="item_add" href="javascript:;"> \u52a0\u5165\u8cfc\u7269\u8eca </a></p></div>')})})}
function _send_factory(a){releasePage(PAGE);$.post("db/retrive_image_factory.php",{userid:$.cookie("user_id"),s_save:a},function(a){a=$.parseJSON(a);var c=$.parseJSON(a[0].saveimag);_producing_for_factory(c,a[0].phone_type)})}var scaling=3;
function mod_saving(a){function b(){var h=q.get(j++);if($(h).length)$status.css("width",function(){f+=m;return f+"%"}),c.push({cornerId:$(h).attr("id"),cornerClass:$(h).attr("class"),cornerStyle:$(h).attr("style")+" width:"+$(h).css("width")+"; height:"+$(h).css("height"),imgURL:$(h).children(".draggable").data("src"),zdx:$(h).children(".draggable").data("zdx"),zdy:$(h).children(".draggable").data("zdy"),zw:$(h).children(".draggable").data("zw"),zh:$(h).children(".draggable").data("zh")}),setTimeout(b,
10);else{$status.after('<br><span style="font-size: 16px; color: white"> \u4e0a\u50b3\u4e2d...</span>');var g=document.createElement("canvas");_show_save(g);$.post("db/save_image.php",{userid:$.cookie("user_id"),user_type:$.cookie("user_type"),title_name:TITLE_NAME,saveimag:JSON.stringify(c),phone_type:PHONE_NAME,layout_no:LAYOUT_NAME,phone_color:PHONE_COLOR,orig_img:g.toDataURL()},function(){TITLE_NAME="";$(g).attr("id","galleryCanvas");$(g).css("position","absolute");$(g).css("top","80px");$(g).css("left",
"200px");$(g).css("width",Math.round(0.7*$("#mCanvas")[0].width)+"px");$(g).css("height",Math.round(0.7*$("#mCanvas")[0].height)+"px");$("body").append($(g));$("#progress-bar").remove();$("#progress-bar")[0]=null;$wDiv.remove();$wDiv[0]=null;a()})}}$("body").append('<div class="modalOverlay"></div>');$wDiv=$(".modalOverlay");if(0!=$(".canvas_appended").length&&$(".canvas_appended").length==$(".layout_corner").length)if(""==TITLE_NAME)Messi.alert('\u8acb\u8f38\u5165\u540d\u7a31 : <input type="text">',
function(a,b){TITLE_NAME=b;saveImg()},{title:"\u63d0\u9192\u60a8 !",modal:!0}),$wDiv.remove();else{$("body").append('<div id="progress-bar"><div id="status"></div></div>');$("#progress-bar").css("position","fixed");$("#progress-bar").css("z-index","1001");$("#progress-bar").css("top","300px");$("#progress-bar").css("left",layout_ox+"px");$status=$("#status");var c=[],m=100/$(".layout_corner").length,f=0,q=$("body").find(".layout_corner"),j=0;b()}else new Messi("<p>\u60a8\u5c1a\u672a\u5b8c\u6210\u8a2d\u8a08\u54e6</p><p>\u8acb\u5148\u5c07\u5716\u7247\u6309\u60a8\u7684\u559c\u597d\u62d6\u62c9\u81f3\u6240\u6709\u7684\u5340\u584a\u5f8c\uff0c\u624d\u80fd\u5132\u5b58</p>",
{title:"\u63d0\u9192\u60a8 !",modal:!0}),$wDiv.remove()}
function _show_save(a){Math.round(parseInt($(".layout_corner").css("border-left-width"),10));var b=a.getContext("2d");$(a).attr("id","galleryCanvas");a.width=Math.round($("#mCanvas")[0].width);a.height=Math.round($("#mCanvas")[0].height);b.drawImage($("#mCanvas")[0],0,0,a.width,a.height);$(".canvas_appended").each(function(){b.drawImage($(this)[0],Math.round(parseInt($(this).css("left"),10))-layout_ox,Math.round(parseInt($(this).css("top"),10))-layout_oy,Math.round(parseInt($(this)[0].width,10)),
Math.round(parseInt($(this)[0].height,10)))})}
function _producing_for_factory(a,b){$("body").append('<div class="modalOverlay"></div>');$wDiv=$(".modalOverlay");$("body").append('<div id="progress-bar"><div id="status"></div></div>');$("#progress-bar").css("position","fixed");$("#progress-bar").css("z-index","1001");$("#progress-bar").css("top","300px");$("#progress-bar").css("left",layout_ox+"px");$status=$("#status");var c=new Image;c.src="images/"+b+"_mask3.png";c.onload=function(){function b(){var a=r[n++];if($(a).length){$status.css("width",
function(){g+=h;return g+"%"});var c=a.cornerStyle.split(";"),p={},s="",t;for(t in c)s=c[t].split(":"),p[$.trim(s[0])]=$.trim(s[1]);var d=$("<div></div>");d.css("position","absolute");d.css("top",Math.round(parseInt(p.top),10)*scaling+"px");d.css("left",Math.round(parseInt(p.left),10)*scaling+"px");d.css("width",Math.round(parseInt(p.width),10)*scaling+"px");d.css("height",Math.round(parseInt(p.height),10)*scaling+"px");d.css("border","6px solid silver");d.addClass(a.cornerClass);d.attr("id",a.cornerId);
$("body").append(d);var k=$("<img/>");k.attr("src",a.imgURL);"undefined"==typeof a.imgURL&&alert(a.cornerId);k.load(function(){var c=new Image;if("undefined"!=typeof a.zdx){k.data("zdx",a.zdx*scaling);k.data("zdy",a.zdy*scaling);k.data("zw",a.zw*scaling);k.data("zh",a.zh*scaling);var f=$("<canvas>"),g=d.clone();f[0].width=parseInt(d.css("width"),10)+parseInt(d.css("border-left-width"),10);f[0].height=parseInt(d.css("height"),10)+parseInt(d.css("border-left-width"),10);autoClipper2(k[0],f,g,d);c.src=
f[0].toDataURL();c.width=f[0].width;c.height=f[0].height}else c.src=k.attr("src");c.onload=function(){0<=d.attr("class").indexOf("layout_circle")?doClipping(doMasking(c,j,d,layout_ox*scaling,layout_oy*scaling),d,cirClipper):0<=d.attr("class").indexOf("layout_square")&&doClipping(doMasking(c,j,d,layout_ox*scaling,layout_oy*scaling),d,boxClipper);q.drawImage(d.next()[0],Math.round(parseInt(d.next().css("left"),10))-layout_ox*scaling,Math.round(parseInt(d.next().css("top"),10))-layout_oy*scaling,Math.round(parseInt(d.next().css("width"),
10)),Math.round(parseInt(d.next().css("height"),10)));d.next().remove();d.next()[0]=null;d.remove();d[0]=null;setTimeout(b,10)}})}else mod_saveremote(f),delete f,f=null,$("#progress-bar").remove(),$("#progress-bar")[0]=null,$wDiv.remove(),$wDiv[0]=null}var f=document.createElement("canvas"),q=f.getContext("2d");f.width=Math.round(c.width);f.height=Math.round(c.height);var j=document.createElement("canvas");j.width=c.width;j.height=c.height;j.getContext("2d").drawImage(c,0,0);var h=100/a.length,g=
0,r=a,n=0;b()}}
function _producing_for_factory_from_layout(a){var b=document.createElement("Canvas");b.setAttribute("id","mCanvas");b.getContext("2d");$(".mainmenu").before(b);$("link[type='text/css']#layout_css").remove();b=jQuery("<link>");b.attr({rel:"stylesheet",type:"text/css",href:"css/"+a.phone_type+"_"+a.layout_no+".css?v="+(new Date).getTime(),id:"layout_css"});$("head").append(b);styleOnload(b[0],function(){var b="js/"+a.phone_type+"_"+a.layout_no+".js?v="+(new Date).getTime();$.getScript(b).done(function(){var b=$.parseJSON(a.saveimag);
$("body").append('<div class="modalOverlay"></div>');$wDiv=$(".modalOverlay");$("body").append('<div id="progress-bar"><div id="status"></div></div>');$("#progress-bar").css("position","fixed");$("#progress-bar").css("z-index","1001");$("#progress-bar").css("top","300px");$("#progress-bar").css("left",layout_ox+"px");$status=$("#status");var c=new Image;c.src="images/"+PHONE_NAME+"_mask3.png";c.onload=function(){function a(){var b=u[v++];if($(b).length){$status.css("width",function(){n+=r;return n+
"%"});var c=b.cornerStyle.split(";"),f={},d="",k;for(k in c)d=c[k].split(":"),f[$.trim(d[0])]=$.trim(d[1]);var e=$("<div></div>");e.css("position","absolute");e.css("top",Math.round(parseInt(f.top),10)*scaling+"px");e.css("left",Math.round(parseInt(f.left),10)*scaling+"px");e.css("width",Math.round(parseInt($("body").find("#"+b.cornerId).css("width")),10)*scaling+"px");e.css("height",Math.round(parseInt($("body").find("#"+b.cornerId).css("height")),10)*scaling+"px");e.css("border","6px solid silver");
e.addClass(b.cornerClass);$("body").append(e);var l=$("<img/>");l.attr("src",b.imgURL);l.load(function(){var c=new Image;if("undefined"!=typeof b.zdx){l.data("zdx",b.zdx*scaling);l.data("zdy",b.zdy*scaling);l.data("zw",b.zw*scaling);l.data("zh",b.zh*scaling);var d=$("<canvas>"),f=e.clone();d[0].width=parseInt(e.css("width"),10)+parseInt(e.css("border-left-width"),10);d[0].height=parseInt(e.css("height"),10)+parseInt(e.css("border-left-width"),10);autoClipper2(l[0],d,f,e);c.src=d[0].toDataURL();c.width=
d[0].width;c.height=d[0].height}else c.src=l.attr("src");c.onload=function(){0<=e.attr("class").indexOf("layout_circle")?doClipping(doMasking(c,g,e,layout_ox*scaling,layout_oy*scaling),e,cirClipper):0<=e.attr("class").indexOf("layout_square")&&doClipping(doMasking(c,g,e,layout_ox*scaling,layout_oy*scaling),e,boxClipper);h.drawImage(e.next()[0],Math.round(parseInt(e.next().css("left"),10))-layout_ox*scaling,Math.round(parseInt(e.next().css("top"),10))-layout_oy*scaling,Math.round(parseInt(e.next().css("width"),
10)),Math.round(parseInt(e.next().css("height"),10)));e.next().remove();e.next()[0]=null;e.remove();e[0]=null;setTimeout(a,10)}})}else mod_saveremote(j),delete j,j=null,$("#progress-bar").remove(),$("#progress-bar")[0]=null,$wDiv.remove(),$wDiv[0]=null}var j=document.createElement("canvas"),h=j.getContext("2d");j.width=Math.round(c.width);j.height=Math.round(c.height);var g=document.createElement("canvas");g.width=c.width;g.height=c.height;g.getContext("2d").drawImage(c,0,0);var r=100/b.length,n=
0,u=b,v=0;a()}}).fail(function(){})})}function mod_saveremote(a){var b=$("<img>");b.attr("id","galleryCanvas");b.css("position","absolute");b.css("top","80px");b.css("left","100px");b.css("width",Math.round(0.7*a.width.width)+"px");b.css("height",Math.round(0.7*a.width.height)+"px");$("body").append(b);$("#galleryCanvas")[0].src=a.toDataURL()}
function setDragObj(a){a.children(".draggable").draggable({scroll:!1,cursor:"auto",cursorAt:{left:35,top:35},revert:"valid",drag:function(){0<=$(this).attr("class").indexOf("ui-draggable-dragging")&&($(this).parent().css("z-index","1000"),$(this).css("opacity","0.7"))},start:function(){disable_scroll();$(this).height($(this).data("oh")).width($(this).data("ow"));$(".layout_corner").css("z-index","998");$(".layout_corner").stop(!0,!0).animate({opacity:1});$(this).data("corner",$(this).parent())},stop:function(){enable_scroll();
0<=$(this).parent().attr("class").indexOf("removed")&&clearCorner($(this).parent())}});a.children(".draggable").css("z-index","");a.removeClass("removed");a.children(".draggable").removeClass("ui-draggable-dragging");a.css("cursor","move");a.css("z-index","998")}
function mod_randesign(){0<$(".layout_corner").children(".spinner").length||(0!=$(".canvas_appended").length?($("body").append('<div class="modalOverlay"></div>'),new Messi("\u60a8\u78ba\u5b9a\u8981\u91cd\u65b0\u96a8\u6a5f\u8a2d\u8a08\u55ce\uff1f\u4e4b\u524d\u7684\u5716\u7247\u5c07\u6703\u88ab\u6e05\u7a7a\uff01",{title:"\u96a8\u6a5f\u8a2d\u8a08",buttons:[{id:0,label:"Yes",val:"Y"},{id:1,label:"No",val:"N"}],callback:function(a){"Y"===a&&_randesign();$(".modalOverlay").remove();$(".layout_corner").animate({opacity:CORNER_OPT})}})):
_randesign())}
function _randesign(){$(".layout_corner").css("opacity",CORNER_OPT);$(".layout_corner").html("");$(".layout_corner > draggable").each(function(){$(this).remove();$(this)[0]=null});$(".canvas_appended").each(function(){$(this).remove();$(this)[0]=null});$(".layout_corner").each(function(){var a=Math.floor(Math.random()*$(".gallery-pool").length);$(this).append($($(".gallery-pool")[a]).clone());$(this).children(".draggable").removeClass("gallery-pool");$(this).children(".draggable").data("oh",Math.round(0.7*
$(".gallery-pool")[a].height));$(this).children(".draggable").data("ow",Math.round(0.7*$(".gallery-pool")[a].width));$(this).children(".draggable").css({position:"relative",top:"0px",left:"0px",width:$(this).css("width"),height:$(this).css("height"),opacity:"0"});var a=$(this).children(".draggable").attr("src"),b=$(this),c=HOST_URL+TEMP_DIR+a.replace(/\//g,"+");$(this).children(".draggable").data("src",c);var m=(new Spinner({lines:13,length:7,width:4,radius:10,corners:1,rotate:0,color:"#000",speed:1,
trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2E9,top:"auto",left:"auto"})).spin($(this)[0]);$.getImageData({url:a,server:HOST_URL+"proxy/getImageData.php",success:function(a){b.children(".draggable").attr("src",a.src);b.children(".draggable").addClass("cached");autoCentered(b,a);b.css("opacity","0");m.stop();setDragObj(b)},error:function(){m.stop()}})})}
function clearDesign(){!(0<$(".layout_corner").children(".spinner").length)&&0!=$(".canvas_appended").length&&($("body").append('<div class="modalOverlay"></div>'),new Messi("\u60a8\u78ba\u5b9a\u8981\u6e05\u9664\u8a2d\u8a08\u55ce\uff1f\u6240\u6709\u7684\u5716\u7247\u5c07\u6703\u88ab\u6e05\u7a7a\uff01",{title:"\u6e05\u9664\u5167\u5bb9",buttons:[{id:0,label:"Yes",val:"Y"},{id:1,label:"No",val:"N"}],callback:function(a){"Y"===a&&($(".layout_corner").length&&$(".layout_corner").children(".draggable").each(function(){$(this).remove();
$(this)[0]=null}),$(".canvas_appended").length&&$(".canvas_appended").each(function(){$(this).remove();$(this)[0]=null}));$(".modalOverlay").remove();$(".layout_corner").animate({opacity:CORNER_OPT})}}))}function styleOnload(a,b){a.attachEvent?a.attachEvent("onload",b):setTimeout(function(){poll(a,b)},0)}
function poll(a,b){if(!b.isCalled){var c=!1;if(/webkit/i.test(navigator.userAgent))a.sheet&&(c=!0);else if(a.sheet)try{a.sheet.cssRules&&(c=!0)}catch(m){1E3===m.code&&(c=!0)}c?setTimeout(function(){b()},1):setTimeout(function(){poll(a,b)},1)}}var keys=[37,38,39,40];function preventDefault(a){a=a||window.event;a.preventDefault&&a.preventDefault();a.returnValue=!1}function keydown(a){for(var b=keys.length;b--;)if(a.keyCode===keys[b]){preventDefault(a);break}}function wheel(a){preventDefault(a)}
function disable_scroll(){window.addEventListener&&window.addEventListener("DOMMouseScroll",wheel,!1);window.onmousewheel=document.onmousewheel=wheel;document.onkeydown=keydown}function enable_scroll(){window.removeEventListener&&window.removeEventListener("DOMMouseScroll",wheel,!1);window.onmousewheel=document.onmousewheel=document.onkeydown=null};